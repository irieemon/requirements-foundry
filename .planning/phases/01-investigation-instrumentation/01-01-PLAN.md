---
phase: 01-investigation-instrumentation
plan: 01
type: execute
---

<objective>
Map the data flow paths for all three generative flows and document where progress updates happen (and where they're missing).

Purpose: Before adding instrumentation, we need a precise understanding of which files handle progress updates, where polling endpoints get their data, and which state transitions are logged vs silent.
Output: DISCOVERY.md with flow diagrams and instrumentation gap analysis for each flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./01-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md

**Key files to trace:**
@lib/observability/logger.ts
@lib/observability/heartbeat.ts
@hooks/use-run-progress.ts
@hooks/use-batch-story-progress.ts
@server/actions/analysis.ts
@server/actions/batch-stories.ts
@app/api/runs/[id]/route.ts
@app/api/runs/[id]/batch-story/route.ts
@app/api/runs/[id]/process-next/route.ts
@app/api/runs/[id]/process-next-upload/route.ts
@lib/run-engine/process-next-trigger.ts

**Prior exploration findings:**
- RunLogger exists but is not used in key paths
- 50+ console.log statements in production code
- Cache headers missing on batch-story progress endpoint
- Card analysis has no current upload tracking in progress response
- Silent failures on initial trigger for card analysis
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trace Card Analysis Progress Flow</name>
  <files>None (investigation only)</files>
  <action>
Trace the complete data flow for card analysis progress:

1. **Entry point**: `server/actions/analysis.ts` → `analyzeProject()`
   - Document: What status is set on Run creation
   - Document: How `triggerProcessNextUploadAsync` is called
   - Document: Error handling if trigger fails

2. **Processing endpoint**: `app/api/runs/[id]/process-next-upload/route.ts`
   - Document: Each `db.run.update()` call and what fields change
   - Document: Each `db.runUpload.update()` call and status transitions
   - Document: Heartbeat update points
   - Document: Continuation trigger points

3. **Polling endpoint**: `app/api/runs/[id]/route.ts`
   - Document: What data is returned to frontend
   - Document: Cache headers present
   - Document: Current item tracking (does it exist?)

4. **Frontend hook**: `hooks/use-run-progress.ts`
   - Document: Polling interval
   - Document: Terminal status detection
   - Document: Progress calculation

Create a flow diagram showing data path and status transitions.
Identify WHERE RunLogger could be added but isn't being used.
  </action>
  <verify>Output includes: flow diagram, status transition table, gap list for card analysis</verify>
  <done>Card analysis flow fully documented with specific instrumentation gaps identified</done>
</task>

<task type="auto">
  <name>Task 2: Trace Epic/Story Generation Progress Flow</name>
  <files>None (investigation only)</files>
  <action>
Trace the complete data flow for epic generation (batch story) progress:

1. **Entry point**: `server/actions/batch-stories.ts` → `startGenerateAllStories()`
   - Document: Run and RunEpic creation
   - Document: How trigger failure is handled (different from card analysis)

2. **Processing endpoint**: `app/api/runs/[id]/process-next/route.ts`
   - Document: Loop structure (processes ALL epics in one invocation)
   - Document: Status updates within loop (GENERATING → SAVING → COMPLETED)
   - Document: Heartbeat update frequency
   - Document: Timeout handling (280s safety margin)
   - Document: AI call duration and what happens during it

3. **Polling endpoint**: `app/api/runs/[id]/batch-story/route.ts`
   - Document: What data is returned
   - Document: Cache headers (MISSING per exploration)
   - Document: Current epic tracking

4. **Frontend hook**: `hooks/use-batch-story-progress.ts`
   - Document: Polling interval
   - Document: How stale recovery is detected
   - Document: Terminal status handling

Create a flow diagram showing data path and status transitions.
Identify WHERE RunLogger IS being used and where gaps exist.
  </action>
  <verify>Output includes: flow diagram, status transition table, gap list for epic generation</verify>
  <done>Epic generation flow fully documented with instrumentation gaps identified</done>
</task>

<task type="auto">
  <name>Task 3: Create DISCOVERY.md with Gap Analysis</name>
  <files>.planning/phases/01-investigation-instrumentation/DISCOVERY.md</files>
  <action>
Create DISCOVERY.md synthesizing findings:

**Structure:**
1. **Flow Diagrams** - ASCII diagrams for both flows showing:
   - Entry → Processing → Polling → Frontend
   - Status transitions at each step
   - Heartbeat update points

2. **Instrumentation Gap Analysis Table:**
   | Location | Current Logging | Gap | Priority | Fix in Plan 02 |
   |----------|-----------------|-----|----------|----------------|

3. **Root Cause Hypotheses** for each symptom:
   - Card analysis frozen progress: What's the likely cause based on tracing?
   - Epic generation no progress: What's the likely cause?
   - Story generation timeout: What's the likely cause?

4. **Specific Fixes Needed** (to inform Plan 02):
   - Files that need RunLogger added
   - Console.logs to replace with structured logging
   - Missing status update points
   - Cache header fixes

**Key questions to answer:**
- Why does card analysis progress appear frozen?
- Why does epic generation show no progress indicator?
- Where does story generation fail silently?
  </action>
  <verify>DISCOVERY.md exists with all sections populated</verify>
  <done>DISCOVERY.md captures complete gap analysis with prioritized fix list</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Card analysis flow traced with specific file:line references
- [ ] Epic generation flow traced with specific file:line references
- [ ] DISCOVERY.md created with actionable gap list
- [ ] Root cause hypotheses documented for all three symptoms
</verification>

<success_criteria>

- All tasks completed
- Flow diagrams accurate and complete
- Gap analysis prioritized for Plan 02
- Clear understanding of what instrumentation to add
</success_criteria>

<output>
After completion, create `.planning/phases/01-investigation-instrumentation/01-01-SUMMARY.md`:

# Phase 1 Plan 1: Investigation Mapping Summary

**[What was discovered - key findings in one line]**

## Accomplishments

- [Flow traced with key findings]
- [Gaps identified]

## Files Analyzed

- `path/to/file.ts` - What was found

## Key Findings

[Most important discoveries]

## Next Step

Ready for 01-02-PLAN.md (Add Instrumentation)
</output>
