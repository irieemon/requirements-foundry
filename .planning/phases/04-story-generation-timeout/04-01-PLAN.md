---
phase: 04-story-generation-timeout
plan: 01
type: execute
---

<objective>
Fix story generation timeout failures by adding self-continuation when approaching Vercel's 300s limit.

Purpose: When processing takes longer than 280s (safety margin), the route gracefully stops but currently relies on cron job (5 min intervals) to resume. This causes the frontend to detect "stale" runs and mark them as failed, resetting the UI. Adding immediate self-continuation eliminates this gap.

Output: Story generation runs that exceed 280s automatically continue with sub-second handoff instead of waiting up to 5 minutes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-investigation-instrumentation/01-01-SUMMARY.md
@.planning/phases/01-investigation-instrumentation/01-02-SUMMARY.md

**Root cause (discovered during planning):**
The `process-next/route.ts` has a timeout safety mechanism that stops processing at 280s. When triggered, it:
1. Sets `timedOut = true`
2. Leaves the run in RUNNING state with pending epics
3. Returns `{ timedOut: true }` response
4. Does NOT trigger continuation - relies on cron job every 5 minutes

The frontend's `getActiveBatchStoryRun()` has a 2-minute stale threshold. If no heartbeat update for 2 minutes, it marks the run as FAILED. This creates a race condition: timeout → 5 min wait for cron → but frontend marks failed after 2 min.

**Key files:**
@app/api/runs/[id]/process-next/route.ts
@lib/run-engine/process-next-trigger.ts

**Tech stack available:**
- triggerProcessNext() for fire-and-forget continuation
- Structured logging via RunLogger

**Constraining decisions from prior phases:**
- 01-02: Added structured logging with RunLogger - use same pattern for continuation logging
- 01-02: Added cache headers to batch-story endpoint - no changes needed there
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add self-continuation on timeout</name>
  <files>app/api/runs/[id]/process-next/route.ts</files>
  <action>
When `timedOut = true` and there are still pending epics, trigger another process-next call before returning:

1. In the timeout handling section (around line 327-337), after logging the timeout warning:
   - Import `triggerProcessNext` from `@/lib/run-engine/process-next-trigger`
   - Call `triggerProcessNext(runId)` to fire-and-forget the continuation
   - Add structured log: `logger.info("run.continuation_triggered", { reason: "timeout" })`

2. Ensure this happens BEFORE the return statement, not after

3. Add a small delay (100ms) between trigger and return to ensure the fetch is initiated

Do NOT modify any other timeout behavior. The graceful timeout handling stays the same - we're just adding immediate continuation instead of waiting for cron.
  </action>
  <verify>
Build passes: `npm run build`
No TypeScript errors
Code review: triggerProcessNext called before return in timeout section
  </verify>
  <done>
- triggerProcessNext() called when timedOut=true
- Structured log added for continuation trigger
- Build succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Self-continuation on timeout - when story generation exceeds 280s, it automatically triggers a continuation instead of waiting for cron job</what-built>
  <how-to-verify>
Testing requires a project with enough epics to exceed 280s processing time:

1. Deploy to Vercel: `vercel --yes`
2. Open project with 10+ epics (or create test data that takes >5 min total)
3. Start "Generate All Stories"
4. Watch the progress panel - after ~4-5 minutes you should see:
   - Progress continues smoothly (no sudden reset)
   - No "stale run" toast notification
   - Stories continue being created across the timeout boundary
5. Check Vercel logs for: `run.continuation_triggered` with `reason: "timeout"`

**Expected behavior:**
- Run completes successfully even if it takes >5 minutes
- Progress panel never resets/disappears mid-run
- Multiple continuation invocations visible in logs if run is very long

**Failure indicators:**
- Progress panel resets to "Generate All Stories" button
- "Recovered from stale run" toast appears
- Run marked as FAILED in database
  </how-to-verify>
  <resume-signal>Type "approved" if continuation works across timeout, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] Vercel deployment succeeds
- [ ] Long-running story generation completes without stale detection
</verification>

<success_criteria>
- Self-continuation triggers when timeout threshold reached
- Runs exceeding 280s continue automatically (no 5-min wait)
- Frontend progress panel stays active throughout long runs
- Structured logging captures continuation events
</success_criteria>

<output>
After completion, create `.planning/phases/04-story-generation-timeout/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Story Generation Timeout Fix Summary

**[One-liner: what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `file.ts` - Description

## Decisions Made
[Key decisions, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
[If more plans: "Ready for 04-02-PLAN.md"]
[If phase complete: "Phase 4 complete, ready for Phase 5"]
</output>
