---
phase: 04-story-generation-timeout
task: 2
total_tasks: 2
status: awaiting_human_verification
last_updated: 2026-01-13T00:45:00Z
---

<current_state>
Task 1 (code implementation) is complete. Waiting at human verification checkpoint (Task 2) for user to deploy and test on Vercel.

The fix adds self-continuation when story generation times out at 280s, eliminating the race condition where frontend marks runs as "stale" before the 5-minute cron job can resume.
</current_state>

<completed_work>
- Task 1: Add self-continuation on timeout - DONE
  - Added `triggerProcessNext` import
  - Added fire-and-forget continuation call when `timedOut = true`
  - Added structured log: `run.continuation_triggered` with `reason: "timeout"`
  - Added 100ms delay before return to ensure fetch initiates
  - Build passes with no TypeScript errors
</completed_work>

<remaining_work>
- Task 2: Human verification checkpoint (BLOCKING)
  - User needs to deploy to Vercel: `vercel --yes`
  - Test with project having 10+ epics (requires >5 min processing)
  - Verify progress panel doesn't reset during timeout boundary
  - Check Vercel logs for `run.continuation_triggered` event
  - User responds "approved" or describes issues

- After approval: Create 04-01-SUMMARY.md
</remaining_work>

<decisions_made>
- Used `triggerProcessNext()` (fire-and-forget) rather than `triggerProcessNextAsync()` because we're inside an API route that stays alive long enough for fetch to initiate
- Added 100ms delay as safety margin to ensure outgoing HTTP request is queued before current request returns
- Updated log message from "will continue on retry" to "will continue" for clarity
</decisions_made>

<blockers>
- Human verification required: Cannot programmatically test timeout behavior - requires real Vercel deployment with >5 min processing time
</blockers>

<context>
The root cause was a race condition:
1. Route times out at 280s, leaves run in RUNNING state
2. Frontend has 2-minute stale threshold
3. Cron job runs every 5 minutes
4. Gap: frontend detects "stale" and marks FAILED before cron can resume

Fix: When timeout occurs, immediately trigger continuation instead of waiting for cron. This gives sub-second handoff instead of up to 5-minute gap.

The code change is minimal and surgical - just added 4 lines in the timeout handling section.
</context>

<next_action>
Start with: Ask user if they're ready to deploy and test, OR if they want to resume later with fresh session.

If resuming fresh session:
1. Read this file
2. Read .planning/phases/04-story-generation-timeout/04-01-PLAN.md for full context
3. Await user's verification result
4. If approved: create 04-01-SUMMARY.md and update STATE.md
5. If issues: fix based on user feedback
</next_action>

<files_modified>
- app/api/runs/[id]/process-next/route.ts (self-continuation logic)
</files_modified>

<verification_instructions>
To test the fix:

1. Deploy: `vercel --yes`

2. Open project with 10+ epics

3. Start "Generate All Stories"

4. Watch progress panel for ~5 minutes:
   - Should continue smoothly across timeout boundary
   - No "stale run" toast
   - No progress reset

5. Check Vercel logs for:
   - `run.continuation_triggered` with `reason: "timeout"`

Expected: Run completes even if >5 minutes, progress never resets
Failure: Progress resets, "stale run" toast, run marked FAILED
</verification_instructions>
