---
phase: 12-jira-export-preview
plan: 01
type: execute
---

<objective>
Create the data layer and tree component for JIRA export preview.

Purpose: Enable users to see exactly what items will be exported before downloading, making the export process transparent and trustworthy.
Output: Server action returning all preview items, and a collapsible tree component showing epic→story→subtask hierarchy.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior work:**
@.planning/phases/11-data-display-hierarchy/11-01-SUMMARY.md
@.planning/phases/11-data-display-hierarchy/11-02-SUMMARY.md
@.planning/phases/11-data-display-hierarchy/11-03-SUMMARY.md

**Codebase context:**
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STRUCTURE.md
@.planning/codebase/CONVENTIONS.md

**Key files:**
@server/actions/jira-export.ts
@lib/export/jira/types.ts
@lib/export/jira/index.ts
@components/export/validate-download.tsx

**Tech stack available:** shadcn/ui (Collapsible, Card, Badge), Tailwind, Lucide icons
**Established patterns:** Container/Presentational split (EpicCard, StoryCard, SubtaskCard), collapsible cards with expand/collapse
**Constraining decisions:** Keep existing shadcn/ui library, maintain Phase 11 visual hierarchy patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create getFullPreviewItems server action</name>
  <files>server/actions/jira-export.ts, lib/export/jira/types.ts</files>
  <action>
Add new server action `getFullPreviewItems(projectId: string, config: ExportConfig)` that returns all normalized items for preview display.

1. In `lib/export/jira/types.ts`, add:
```typescript
export interface PreviewItem {
  tempId: string;
  parentTempId: string | null;
  issueType: "Epic" | "Story" | "Sub-task";
  code: string;
  title: string;
  priority: string | null;
  effort: string | null;
  // Derived display fields
  storyCount?: number;
  subtaskCount?: number;
}

export interface FullPreviewData {
  items: PreviewItem[];
  stats: ExportStats;
  validation: ValidationResult;
}
```

2. In `server/actions/jira-export.ts`, add:
```typescript
export async function getFullPreviewItems(
  projectId: string,
  config: ExportConfig
): Promise<FullPreviewData>
```

Implementation:
- Call `extractExportData()` to get raw data
- Call `normalizeForExport()` to get full normalized list
- Map to `PreviewItem[]` (lighter than full NormalizedItem - just display fields)
- Calculate counts per epic (storyCount) and per story (subtaskCount)
- Return items, stats, and validation

Avoid: Don't return full descriptions/acceptance criteria - keep payload light for preview. Don't duplicate existing previewExport logic, reuse extractExportData/normalizeForExport.
  </action>
  <verify>
Import and call `getFullPreviewItems` in a temporary test - verify it returns items array with expected structure.
`npx tsc --noEmit` passes without type errors.
  </verify>
  <done>
getFullPreviewItems action exists, returns PreviewItem array with counts, TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ExportPreviewTree component</name>
  <files>components/export/export-preview-tree.tsx</files>
  <action>
Create a collapsible tree component showing the export hierarchy.

Component requirements:
1. Props: `items: PreviewItem[]`, `loading?: boolean`
2. Group items by hierarchy: epics contain stories, stories contain subtasks
3. Use shadcn Collapsible for expand/collapse (matching StoryCard/SubtaskCard patterns)
4. Visual hierarchy from Phase 11:
   - Epic row: heavier weight, icon, title, story count badge
   - Story row (indented): medium weight, priority badge, subtask count
   - Subtask row (double indented): lightest weight, just title

Structure:
```tsx
<div className="space-y-2">
  {epics.map(epic => (
    <Collapsible key={epic.tempId}>
      <CollapsibleTrigger>
        {/* Epic row with expand chevron, title, badges */}
      </CollapsibleTrigger>
      <CollapsibleContent>
        {stories.map(story => (
          <Collapsible key={story.tempId}>
            {/* Story row with expand, title, priority, subtask count */}
            <CollapsibleContent>
              {subtasks.map(subtask => (
                {/* Subtask row - simple, no expand */}
              ))}
            </CollapsibleContent>
          </Collapsible>
        ))}
      </CollapsibleContent>
    </Collapsible>
  ))}
</div>
```

Styling:
- Use muted backgrounds for nesting indication (bg-muted/30 for stories, bg-muted/50 for subtasks)
- Compact text (text-sm for stories, text-xs for subtasks)
- Priority badges: same color mapping as StoryCard (Must=red, Should=amber, Could=blue, Won't=slate)
- Effort badge if present

Loading state: Show skeleton rows while loading.

Avoid: Don't make this too complex - it's a preview, not the main data view. Don't add edit capabilities.
  </action>
  <verify>
Component imports and renders without errors.
Tree structure correctly groups items by parent-child relationships.
Expand/collapse works for epics and stories.
  </verify>
  <done>
ExportPreviewTree component exists, displays hierarchy with proper indentation, collapsible at epic and story level, matches Phase 11 visual style.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes without errors
- [ ] `npm run lint` passes
- [ ] getFullPreviewItems returns correct data structure
- [ ] ExportPreviewTree renders hierarchy correctly
</verification>

<success_criteria>
- Server action returns all preview items with hierarchy info
- Tree component displays epics → stories → subtasks
- Collapsible behavior works correctly
- Visual styling consistent with Phase 11 patterns
</success_criteria>

<output>
After completion, create `.planning/phases/12-jira-export-preview/12-01-SUMMARY.md`
</output>
