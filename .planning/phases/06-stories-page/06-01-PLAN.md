---
phase: 06-stories-page
plan: 01
type: execute
---

<objective>
Add stories section to project detail page, following the established pattern for uploads/cards/epics/runs sections.

Purpose: Enable users to view all stories within a project, grouped by epic, without navigating to individual epic detail pages.
Output: Stories section accessible via `?section=stories` on project page, with KPI count and story table grouped by epic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant source files:
@app/projects/[id]/page.tsx
@server/actions/projects.ts
@components/stories/story-table.tsx
@components/ui/navigable-kpi-card.tsx

# Established patterns:
- Tab-based navigation via `?section=` query param
- KPI strip with NavigableKpiCard components
- Conditional section rendering based on activeSection
- EmptyState component for empty sections
- Card wrapper with CardHeader/CardContent for section content

# Key files from prior phases:
- StoryTable already exists and handles story display with expansion
- getProject already fetches epics with `_count: { select: { stories: true } }`
- Epics have stories relation, stories don't have direct project relation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend getProject to include stories with epic context</name>
  <files>server/actions/projects.ts</files>
  <action>
Modify `getProject` to include stories data when fetching a project:

1. In the `epics` include, add stories with their full data:
   ```typescript
   epics: {
     orderBy: { priority: "asc" },
     include: {
       _count: { select: { stories: true } },
       stories: {
         orderBy: { code: "asc" },
         select: {
           id: true,
           code: true,
           title: true,
           userStory: true,
           persona: true,
           acceptanceCriteria: true,
           technicalNotes: true,
           priority: true,
           effort: true,
         },
       },
     },
   },
   ```

2. Add story count to the _count aggregation. Since stories don't have direct project relation, we need to compute this. Add a raw count query or compute from epics:
   - Option A: After fetching project, compute `totalStories = project.epics.reduce((sum, e) => sum + e._count.stories, 0)`
   - Option B: Add a separate Prisma query for total story count

   Use Option A (compute from already-fetched epics data) to avoid extra query.

Note: The stories are nested under epics, so the return type will have `epics[].stories[]` structure.
  </action>
  <verify>TypeScript compiles without errors: `npm run build` or `npx tsc --noEmit`</verify>
  <done>getProject returns epics with full stories data for display</done>
</task>

<task type="auto">
  <name>Task 2: Add stories section to project detail page</name>
  <files>app/projects/[id]/page.tsx</files>
  <action>
Extend the project detail page to include a stories section:

1. Update `validSections` array to include "stories":
   ```typescript
   const validSections: Section[] = ["uploads", "cards", "epics", "runs", "stories"];
   ```

2. Compute total story count (for KPI card):
   ```typescript
   const totalStories = project.epics.reduce((sum, epic) => sum + epic._count.stories, 0);
   ```

3. Add NavigableKpiCard for stories in the KpiStrip (after Runs):
   ```tsx
   <NavigableKpiCard
     label="Stories"
     value={totalStories}
     iconName="FileText"
     section="stories"
     projectId={project.id}
   />
   ```

4. Add stories section content (after runs section):
   ```tsx
   {activeSection === "stories" && (
     <StoriesSection epics={project.epics} />
   )}
   ```

5. Import the new StoriesSection component (will be created in Task 3).

Note: Use "FileText" icon (already imported) or consider "ScrollText" for stories.
  </action>
  <verify>Page loads without errors, stories KPI card appears in strip</verify>
  <done>Stories section accessible via ?section=stories, KPI shows story count</done>
</task>

<task type="auto">
  <name>Task 3: Create StoriesSection component</name>
  <files>components/stories/stories-section.tsx</files>
  <action>
Create a new component to display stories grouped by epic:

```tsx
"use client";

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { EmptyState } from "@/components/layout/empty-state";
import { StoryTable } from "./story-table";
import { FileText, BookOpen } from "lucide-react";

interface Story {
  id: string;
  code: string;
  title: string;
  userStory: string;
  persona: string | null;
  acceptanceCriteria: string | null;
  technicalNotes: string | null;
  priority: string | null;
  effort: string | null;
}

interface Epic {
  id: string;
  code: string;
  title: string;
  _count: { stories: number };
  stories: Story[];
}

interface StoriesSectionProps {
  epics: Epic[];
}

export function StoriesSection({ epics }: StoriesSectionProps) {
  const totalStories = epics.reduce((sum, epic) => sum + epic._count.stories, 0);

  if (totalStories === 0) {
    return (
      <Card className="border-border/50 shadow-sm">
        <CardHeader>
          <CardTitle>User Stories</CardTitle>
          <CardDescription>Stories generated for this project&apos;s epics.</CardDescription>
        </CardHeader>
        <CardContent>
          <EmptyState
            icon={FileText}
            title="No stories yet"
            description="Generate stories from epics in the Epics section."
            compact
          />
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      <Card className="border-border/50 shadow-sm">
        <CardHeader>
          <CardTitle>User Stories</CardTitle>
          <CardDescription>
            {totalStories} stories across {epics.filter(e => e._count.stories > 0).length} epics
          </CardDescription>
        </CardHeader>
      </Card>

      {epics.filter(epic => epic.stories.length > 0).map(epic => (
        <Card key={epic.id} className="border-border/50 shadow-sm">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-base">
              <Badge variant="outline">{epic.code}</Badge>
              {epic.title}
            </CardTitle>
            <CardDescription>{epic._count.stories} stories</CardDescription>
          </CardHeader>
          <CardContent>
            <StoryTable stories={epic.stories} />
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
```

Key points:
- Groups stories under their parent epic
- Reuses existing StoryTable component (no duplication)
- Shows empty state when no stories exist
- Filters out epics with no stories from display
- Consistent with project page Card styling
  </action>
  <verify>Component compiles, displays stories grouped by epic correctly</verify>
  <done>StoriesSection shows all project stories grouped by epic with expandable rows</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Navigate to project page, click Stories KPI card
- [ ] Stories section shows correct count
- [ ] Stories grouped by epic with expandable rows work
- [ ] Empty state displays correctly when no stories exist
- [ ] Existing story table functionality preserved (expansion, dialog)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Stories section accessible via ?section=stories
- KPI card shows accurate story count
- Stories displayed grouped by epic using existing StoryTable component
- Empty state shown when no stories
</success_criteria>

<output>
After completion, create `.planning/phases/06-stories-page/06-01-SUMMARY.md` using the template in ~/.claude/get-shit-done/templates/summary-template.md
</output>
