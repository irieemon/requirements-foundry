---
phase: 18-context-schema-upload-form
plan: 01
type: execute
---

<objective>
Add structured context fields to the document upload flow, allowing users to provide project basics, document classification, and notes during upload.

Purpose: Enable richer context for AI analysis by capturing user-provided metadata alongside documents.
Output: Upload context schema in database, context form component, modified upload flow storing context.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Codebase context:**
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md

**Existing upload flow:**
@components/uploads/multi-file-upload.tsx
@app/api/uploads/route.ts
@prisma/schema.prisma

**Form patterns:**
@components/ui/form.tsx
@components/ui/input.tsx
@components/ui/select.tsx
@components/ui/textarea.tsx

**Established patterns:**
- React-hook-form + Zod for form validation
- shadcn/ui form components
- Server Actions for mutations
- Two-phase upload: client → Blob, then Blob URL → API
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UploadContext schema to Prisma</name>
  <files>prisma/schema.prisma</files>
  <action>
Add UploadContext model linked to Upload with fields:
- id (cuid)
- uploadId (String, unique - one context per upload)
- upload relation

Project Basics fields:
- projectType (String, optional) - e.g., "new-development", "enhancement", "migration"
- businessDomain (String, optional) - e.g., "healthcare", "finance", "retail"
- targetAudience (String, optional) - description of end users

Document Classification fields:
- documentType (String, optional) - e.g., "requirements", "design", "meeting-notes", "analysis"
- confidentiality (String, optional) - e.g., "public", "internal", "confidential"
- sourceSystem (String, optional) - where the doc came from

Freeform fields:
- notes (String, optional, @db.Text) - any additional context user wants to provide
- keyTerms (String, optional) - comma-separated domain terms to recognize

Timestamps:
- createdAt DateTime @default(now())
- updatedAt DateTime @updatedAt

Add relation field on Upload model:
- context UploadContext? (optional back-reference)

Add index on uploadId for efficient lookups.

Run `npx prisma validate` and `npx prisma generate` after changes.
  </action>
  <verify>
npx prisma validate passes without errors
npx prisma generate succeeds
TypeScript imports UploadContext from @prisma/client
  </verify>
  <done>
Schema valid, types generated, UploadContext model with all fields defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Create upload context form component</name>
  <files>components/uploads/upload-context-form.tsx, lib/uploads/context-schema.ts</files>
  <action>
Create Zod schema in lib/uploads/context-schema.ts:
```typescript
import { z } from "zod";

export const uploadContextSchema = z.object({
  // Project Basics
  projectType: z.enum(["new-development", "enhancement", "migration", "maintenance", "other"]).optional(),
  businessDomain: z.string().max(100).optional(),
  targetAudience: z.string().max(500).optional(),

  // Document Classification
  documentType: z.enum(["requirements", "design", "meeting-notes", "analysis", "specification", "other"]).optional(),
  confidentiality: z.enum(["public", "internal", "confidential"]).optional(),
  sourceSystem: z.string().max(100).optional(),

  // Freeform
  notes: z.string().max(2000).optional(),
  keyTerms: z.string().max(500).optional(),
});

export type UploadContextFormData = z.infer<typeof uploadContextSchema>;
```

Create UploadContextForm component in components/uploads/upload-context-form.tsx:
- "use client" directive
- Accept props: onSubmit (callback), onSkip (optional callback), defaultValues (optional)
- Use react-hook-form with zodResolver
- Three collapsible sections with Collapsible component:
  1. "Project Basics" - projectType (Select), businessDomain (Input), targetAudience (Textarea)
  2. "Document Classification" - documentType (Select), confidentiality (Select), sourceSystem (Input)
  3. "Additional Context" - notes (Textarea), keyTerms (Input with hint "comma-separated")
- Submit button "Continue with Upload" and Skip button "Skip (Upload Only)"
- Follow existing shadcn form patterns (Form, FormField, FormItem, FormLabel, FormControl, FormMessage)
- Keep sections collapsed by default, user expands what they want to fill
- Use Accordion pattern for clean collapsible sections (if available) or simple collapsible divs
  </action>
  <verify>
TypeScript compiles without errors
Component renders in isolation (can add to a test page temporarily)
Form validation works (submit with invalid data shows errors)
  </verify>
  <done>
Zod schema exports uploadContextSchema and UploadContextFormData type
Component renders 3 collapsible sections with all fields
Submit and Skip buttons work with callbacks
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate context form into upload flow</name>
  <files>components/uploads/multi-file-upload.tsx, app/api/uploads/route.ts</files>
  <action>
Modify MultiFileUpload component:
1. Add state: showContextForm (boolean), contextData (UploadContextFormData | null)
2. After files are selected but BEFORE upload starts:
   - Show UploadContextForm in a Card or section above the file list
   - When user submits form, store contextData and proceed to upload
   - When user clicks Skip, set contextData to null and proceed to upload
3. Include contextData in the POST body to /api/uploads (add `context?: UploadContextFormData` to ProcessUploadRequest type)
4. Pass same context for all files in a batch (context applies to the upload session)

Modify /api/uploads route.ts POST handler:
1. Accept optional `context` field in request body
2. After creating Upload record successfully, if context provided:
   - Create UploadContext record linked to uploadId
   - Use the same transaction or sequential create (Prisma will handle FK)
3. Return success as before

Flow becomes:
1. User selects files → files appear in list
2. Context form appears (collapsed sections)
3. User fills optional context OR clicks Skip
4. Upload proceeds with context data stored per-upload

DO NOT change the existing blob upload flow or break the two-phase pattern.
  </action>
  <verify>
Upload flow works end-to-end:
1. Select files
2. Context form appears
3. Fill some fields, click Continue
4. Files upload successfully
5. Check database: Upload record exists, UploadContext record exists with correct uploadId
Also test Skip flow: UploadContext record should NOT be created when skipped
  </verify>
  <done>
Context form appears after file selection
Context data stored in UploadContext table when provided
Skip creates uploads without context
Existing upload functionality preserved
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx prisma validate` passes
- [ ] `npm run build` succeeds without errors
- [ ] Upload flow shows context form after selecting files
- [ ] Context data persists to UploadContext table
- [ ] Skip bypasses context storage
- [ ] Existing uploads without context still work (backward compatible)
</verification>

<success_criteria>
- UploadContext model exists in schema with all fields
- Zod schema validates context form data
- UploadContextForm component renders collapsible sections
- MultiFileUpload integrates form into flow
- API stores context when provided
- No regression in existing upload functionality
</success_criteria>

<output>
After completion, create `.planning/phases/18-context-schema-upload-form/18-01-SUMMARY.md` using summary template.
</output>
