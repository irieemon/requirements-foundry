---
phase: 09-performance-optimization
plan: 01
type: execute
---

<objective>
Implement zero-risk batch database operations to reduce DB roundtrips by 5-10x per generation cycle.

Purpose: Improve performance without any risk of breaking existing functionality.
Output: Story and card creation using batch `createMany()` instead of individual `create()` loops.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-performance-optimization/DISCOVERY.md

# Source files to modify:
@app/api/runs/[id]/process-next/route.ts
@lib/run-engine/executor.ts
@lib/run-engine/batch-story-executor.ts

# Key insight from discovery:
Current pattern: Individual `create()` calls in a loop = N database roundtrips
Better pattern: Single `createMany()` call = 1 database roundtrip
Expected improvement: 5-10x fewer DB calls per epic/upload
</context>

<tasks>

<task type="auto">
  <name>Task 1: Batch story creation in process-next route</name>
  <files>app/api/runs/[id]/process-next/route.ts</files>
  <action>
Find the story creation loop (approximately lines 317-333) that looks like:
```typescript
for (const story of result.data) {
  await db.story.create({...});
}
```

Replace with batch operation:
```typescript
const storiesData = result.data.map((story, index) => ({
  epicId: epic.id,
  code: story.code || `S${index + 1}`,
  title: story.title,
  description: story.description || "",
  acceptanceCriteria: story.acceptanceCriteria || "",
  asA: story.asA || "",
  iWant: story.iWant || "",
  soThat: story.soThat || "",
  priority: story.priority,
  estimatedPoints: story.estimatedPoints,
  personas: story.personas || [],
}));

await db.story.createMany({ data: storiesData });
```

Keep the logging and counter updates unchanged - just batch the actual creation.
  </action>
  <verify>npx tsc --noEmit passes; grep -n "createMany" app/api/runs/[id]/process-next/route.ts shows the batch operation</verify>
  <done>Story creation uses createMany instead of individual create calls</done>
</task>

<task type="auto">
  <name>Task 2: Batch story creation in batch-story-executor</name>
  <files>lib/run-engine/batch-story-executor.ts</files>
  <action>
Find the story creation loop (similar pattern to process-next route) and apply the same batch transformation:

```typescript
const storiesData = result.data.map((story, index) => ({
  epicId: epic.id,
  code: story.code || `S${index + 1}`,
  title: story.title,
  description: story.description || "",
  acceptanceCriteria: story.acceptanceCriteria || "",
  asA: story.asA || "",
  iWant: story.iWant || "",
  soThat: story.soThat || "",
  priority: story.priority,
  estimatedPoints: story.estimatedPoints,
  personas: story.personas || [],
}));

await db.story.createMany({ data: storiesData });
```

Preserve existing logging and counter logic.
  </action>
  <verify>npx tsc --noEmit passes; grep -n "createMany" lib/run-engine/batch-story-executor.ts shows the batch operation</verify>
  <done>Batch story executor uses createMany for story creation</done>
</task>

<task type="auto">
  <name>Task 3: Batch card creation in executor</name>
  <files>lib/run-engine/executor.ts</files>
  <action>
Find the card creation loop (approximately lines 150-168) and batch it:

```typescript
const cardsData = result.cards.map(cardData => ({
  uploadId: upload.id,
  projectId: upload.projectId,
  code: cardData.code,
  title: cardData.title,
  description: cardData.description,
  priority: cardData.priority,
  type: cardData.type,
  source: cardData.source,
}));

await db.card.createMany({ data: cardsData });
```

Update the card count tracking after the batch operation.
  </action>
  <verify>npx tsc --noEmit passes; grep -n "createMany" lib/run-engine/executor.ts shows the batch operation</verify>
  <done>Card creation uses createMany instead of individual create calls</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] All three files use `createMany()` for bulk creation
- [ ] No TypeScript errors
- [ ] Existing tests pass (if any)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Story creation batched in process-next route
- Story creation batched in batch-story-executor
- Card creation batched in executor
- No functional changes to existing behavior
</success_criteria>

<output>
After completion, create `.planning/phases/09-performance-optimization/09-01-SUMMARY.md`
</output>
