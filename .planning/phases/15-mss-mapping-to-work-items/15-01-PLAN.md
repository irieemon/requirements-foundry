---
phase: 15-mss-mapping-to-work-items
plan: 01
type: execute
---

<objective>
Add MSS (Master Service Schedule) assignment capability to epics and stories, with AI auto-assignment during generation.

Purpose: Enable automatic L3 service line categorization of work items during generation, supporting effort visibility and reporting in Phase 16.
Output: Schema with MSS relations, server actions for MSS updates, AI prompt enhancements for auto-assignment.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-mss-mapping-to-work-items/15-CONTEXT.md
@.planning/phases/13-mss-data-model/13-01-SUMMARY.md
@.planning/phases/14-mss-management-ui/14-01-SUMMARY.md

**Key files:**
@prisma/schema.prisma
@server/actions/generation.ts
@server/actions/mss.ts
@lib/ai/provider.ts
@lib/mss/types.ts

**Tech stack available:** Prisma, Next.js server actions, Anthropic Claude API
**Established patterns:** Optional FK relations, server actions return `{success, data?, error?}`, AI prompts return JSON arrays

**Constraining decisions:**
- Phase 13: MSS schema uses MssServiceLine (L2) → MssServiceArea (L3) → MssActivity (L4)
- Phase 15 context: Map at L3 level (MssServiceArea), stories inherit from epic
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MSS relations to Epic and Story models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add optional `mssServiceAreaId` field to both Epic and Story models:

1. In the Epic model (around line 124):
   - Add `mssServiceAreaId String?` field
   - Add `mssServiceArea MssServiceArea? @relation(fields: [mssServiceAreaId], references: [id], onDelete: SetNull)`
   - Add `@@index([mssServiceAreaId])` for query performance

2. In the Story model (around line 151):
   - Add `mssServiceAreaId String?` field
   - Add `mssServiceArea MssServiceArea? @relation(fields: [mssServiceAreaId], references: [id], onDelete: SetNull)`
   - Add `@@index([mssServiceAreaId])` for query performance

3. In the MssServiceArea model (around line 408):
   - Add `epics Epic[]` relation
   - Add `stories Story[]` relation

Use `onDelete: SetNull` so deleting an MSS entry doesn't cascade-delete work items.

Run `npx prisma db push` after changes.
  </action>
  <verify>npx prisma validate passes, npx prisma db push succeeds without errors</verify>
  <done>Epic and Story models have optional mssServiceAreaId FK, MssServiceArea has reverse relations, database updated</done>
</task>

<task type="auto">
  <name>Task 2: Create MSS update server actions</name>
  <files>server/actions/mss.ts, lib/mss/types.ts</files>
  <action>
Add server actions to update MSS assignment for epics and stories:

1. In `lib/mss/types.ts`, add types:
```typescript
export interface MssAssignmentResult {
  success: boolean;
  error?: string;
}
```

2. In `server/actions/mss.ts`, add:

```typescript
export async function updateEpicMss(
  epicId: string,
  mssServiceAreaId: string | null
): Promise<MssAssignmentResult>
```
- Validate epicId exists
- If mssServiceAreaId provided, validate it exists in MssServiceArea
- Update epic.mssServiceAreaId
- Return success/error

```typescript
export async function updateStoryMss(
  storyId: string,
  mssServiceAreaId: string | null
): Promise<MssAssignmentResult>
```
- Same pattern as updateEpicMss but for stories

```typescript
export async function getMssServiceAreaByCode(
  code: string
): Promise<{ id: string; name: string; code: string } | null>
```
- Look up MssServiceArea by code (case-insensitive)
- Return id, name, code or null if not found
- Used by AI integration to resolve code → ID
  </action>
  <verify>TypeScript compiles without errors, `npm run build` passes</verify>
  <done>Three new server actions exported: updateEpicMss, updateStoryMss, getMssServiceAreaByCode</done>
</task>

<task type="auto">
  <name>Task 3: Update AI epic generation with MSS assignment</name>
  <files>lib/ai/provider.ts, server/actions/generation.ts</files>
  <action>
Modify epic generation to include MSS context and auto-assign L3 category:

1. In `lib/ai/provider.ts`, update `AnthropicProvider.generateEpics`:
   - Add optional `mssContext?: string` parameter to method signature
   - Update the AIProvider interface to match
   - In the prompt, after project context, add MSS hierarchy context:
     ```
     SERVICE LINE TAXONOMY (L2 → L3):
     ${mssContext}

     For each epic, assign the most appropriate L3 service area code based on the epic's content.
     ```
   - Update JSON format to include `mssServiceAreaCode` field (string, the L3 code like "CLD" or "DBA")
   - Update MockProvider similarly for consistency

2. In `lib/types.ts` or where EpicData is defined:
   - Add `mssServiceAreaCode?: string` to EpicData type

3. In `server/actions/generation.ts`, update `generateEpicsForProject`:
   - Before calling provider.generateEpics, fetch MSS hierarchy:
     ```typescript
     const mssHierarchy = await getMssHierarchy();
     const mssContext = mssHierarchy.length > 0
       ? mssHierarchy.map(l2 =>
           `${l2.code} - ${l2.name}:\n${l2.serviceAreas.map(l3 =>
             `  ${l3.code} - ${l3.name}`
           ).join('\n')}`
         ).join('\n\n')
       : '';
     ```
   - Pass mssContext to generateEpics
   - When creating epics in the loop, resolve mssServiceAreaCode → ID:
     ```typescript
     let mssServiceAreaId: string | null = null;
     if (epic.mssServiceAreaCode) {
       const mssArea = await getMssServiceAreaByCode(epic.mssServiceAreaCode);
       mssServiceAreaId = mssArea?.id ?? null;
     }
     ```
   - Include mssServiceAreaId in the db.epic.create data

If no MSS data exists (empty hierarchy), skip MSS context in prompt and leave field null.
  </action>
  <verify>npm run build passes, generateEpicsForProject function compiles without type errors</verify>
  <done>Epic generation includes MSS context, AI assigns L3 codes, codes resolved to IDs and stored in database</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` passes
- [ ] `npx prisma db push` succeeds
- [ ] `npm run build` succeeds without errors
- [ ] Epic and Story models have mssServiceAreaId field
- [ ] Server actions updateEpicMss, updateStoryMss, getMssServiceAreaByCode exist
- [ ] generateEpics prompt includes MSS hierarchy when available
- [ ] Epic creation includes mssServiceAreaId resolution
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Schema supports MSS assignment for epics and stories
- AI epic generation auto-assigns L3 service area codes
- Server actions ready for UI integration in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/15-mss-mapping-to-work-items/15-01-SUMMARY.md`
</output>
