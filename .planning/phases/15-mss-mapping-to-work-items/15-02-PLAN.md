---
phase: 15-mss-mapping-to-work-items
plan: 02
type: execute
---

<objective>
Add inline MSS display and editing to epic and story cards.

Purpose: Allow users to see AI-assigned MSS categories and manually correct them when needed.
Output: MSS selector component, updated epic-card with MSS display, updated story-card with MSS display.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-mss-mapping-to-work-items/15-CONTEXT.md
@.planning/phases/15-mss-mapping-to-work-items/15-01-SUMMARY.md

**Key files:**
@components/epics/epic-card.tsx
@components/stories/story-card.tsx
@components/mss/mss-hierarchy-viewer.tsx
@server/actions/mss.ts
@lib/mss/types.ts

**Tech stack available:** React, shadcn/ui (Popover, Command, Badge), Lucide icons
**Established patterns:** Click-to-edit inline fields, Badge for metadata display, Popover for dropdowns

**Constraining decisions:**
- Phase 15 context: MSS displays inline, click to open selector, keep it clean
- Map at L3 level (show L3 options grouped by L2 parent)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MSS selector component</name>
  <files>components/mss/mss-selector.tsx</files>
  <action>
Create a reusable MSS selector component that shows L3 options grouped by L2:

1. Create `components/mss/mss-selector.tsx`:
   - Props: `value: string | null` (current mssServiceAreaId), `onSelect: (id: string | null) => void`, `disabled?: boolean`
   - Use Popover + Command pattern (like shadcn combobox)
   - Trigger: Badge showing current MSS (L3 name) or "No MSS" placeholder
   - Content: Searchable list with L3 options grouped by L2 headers
   - Include "Clear" option to remove MSS assignment

2. Structure:
```tsx
<Popover>
  <PopoverTrigger asChild>
    <Badge variant="outline" className="cursor-pointer hover:bg-accent">
      <Layers className="mr-1 h-3 w-3" />
      {selectedArea?.name || "No service line"}
    </Badge>
  </PopoverTrigger>
  <PopoverContent className="w-[300px] p-0">
    <Command>
      <CommandInput placeholder="Search service lines..." />
      <CommandList>
        <CommandEmpty>No results found.</CommandEmpty>
        <CommandItem onSelect={() => onSelect(null)}>
          <span className="text-muted-foreground">Clear selection</span>
        </CommandItem>
        {hierarchy.map(l2 => (
          <CommandGroup key={l2.id} heading={`${l2.code} - ${l2.name}`}>
            {l2.serviceAreas.map(l3 => (
              <CommandItem key={l3.id} onSelect={() => onSelect(l3.id)}>
                <Check className={cn("mr-2 h-4 w-4", value === l3.id ? "opacity-100" : "opacity-0")} />
                {l3.code} - {l3.name}
              </CommandItem>
            ))}
          </CommandGroup>
        ))}
      </CommandList>
    </Command>
  </PopoverContent>
</Popover>
```

3. Fetch hierarchy using `getMssHierarchy()` on mount (use React Query or useEffect)
4. Handle loading state (skeleton badge)
5. Handle empty state (no MSS data - show disabled badge with tooltip)

Use existing shadcn components: Popover, Command, Badge from `@/components/ui/`.
  </action>
  <verify>Component renders without errors, shows placeholder when no value, dropdown opens on click</verify>
  <done>MssSelector component created with searchable L2â†’L3 hierarchy dropdown</done>
</task>

<task type="auto">
  <name>Task 2: Add MSS display to epic-card</name>
  <files>components/epics/epic-card.tsx, components/epics/epics-section.tsx</files>
  <action>
Update epic-card to display MSS with inline editing:

1. Update `EpicCardProps` interface to include MSS data:
```typescript
epic: {
  // existing fields...
  mssServiceArea?: {
    id: string;
    code: string;
    name: string;
  } | null;
};
onMssChange?: (epicId: string, mssServiceAreaId: string | null) => void;
```

2. In the epic-card footer (after impact/effort badges), add MSS selector:
```tsx
<MssSelector
  value={epic.mssServiceArea?.id ?? null}
  onSelect={(id) => onMssChange?.(epic.id, id)}
  disabled={!onMssChange}
/>
```

3. If no onMssChange provided, show read-only badge (no Popover, just display).

4. Update `components/epics/epics-section.tsx` (or wherever epics are queried):
   - Include `mssServiceArea: { select: { id: true, code: true, name: true } }` in Prisma include
   - Add handler function that calls `updateEpicMss` server action
   - Pass onMssChange to EpicCard
   - Use optimistic update or refresh after change

5. Style: MSS badge should be visually distinct but subtle - use `Layers` icon, muted colors.
  </action>
  <verify>Epic cards show MSS badge, clicking opens selector, selection updates database</verify>
  <done>Epic cards display MSS with inline editing via MssSelector</done>
</task>

<task type="auto">
  <name>Task 3: Add MSS display to story-card</name>
  <files>components/stories/story-card.tsx, components/stories/stories-section.tsx, app/projects/[id]/stories/page.tsx</files>
  <action>
Update story-card to display MSS (inherited from epic, with optional override):

1. Update `StoryCardProps` interface:
```typescript
story: {
  // existing fields...
  mssServiceArea?: {
    id: string;
    code: string;
    name: string;
  } | null;
  epic?: {
    mssServiceArea?: {
      id: string;
      code: string;
      name: string;
    } | null;
  };
};
onMssChange?: (storyId: string, mssServiceAreaId: string | null) => void;
```

2. In story-card, add MSS display in the secondary row (after persona badge):
```tsx
<MssSelector
  value={story.mssServiceArea?.id ?? story.epic?.mssServiceArea?.id ?? null}
  onSelect={(id) => onMssChange?.(story.id, id)}
  disabled={!onMssChange}
/>
```

3. Show visual indicator if story MSS differs from epic MSS (e.g., small dot or different badge style).

4. Update stories query in `app/projects/[id]/stories/page.tsx` or stories-section:
   - Include `mssServiceArea: { select: { id: true, code: true, name: true } }`
   - Include `epic: { select: { mssServiceArea: { select: { id: true, code: true, name: true } } } }`
   - Add handler for `updateStoryMss` server action

5. For stories page grouped by epic, the epic header should also show MSS (read-only or editable).
  </action>
  <verify>Story cards show MSS (inherited or own), clicking opens selector, selection persists</verify>
  <done>Story cards display MSS with inheritance from epic and optional override</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>MSS assignment during epic generation and inline editing on epic/story cards</what-built>
  <how-to-verify>
    1. Ensure MSS taxonomy is loaded (visit /mss, import CSV if empty)
    2. Run: npm run dev
    3. Navigate to a project and generate epics (or use existing project)
    4. Visit the epics page - confirm:
       - Each epic shows an MSS badge (or "No service line" if AI didn't assign)
       - Clicking the badge opens a searchable dropdown with L3 options grouped by L2
       - Selecting an option updates the badge immediately
    5. Visit the stories page - confirm:
       - Stories show inherited MSS from their epic
       - Clicking the MSS badge allows override
       - Changes persist after page refresh
    6. Generate new epics on a fresh project with MSS data loaded - confirm AI assigns L3 codes
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] MssSelector component renders correctly
- [ ] Epic cards show MSS badge with working dropdown
- [ ] Story cards show inherited MSS with override capability
- [ ] MSS changes persist to database
- [ ] Human verification approved
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- No TypeScript errors
- MSS displays inline on epics and stories
- Click-to-edit works smoothly
- Phase 15 complete
</success_criteria>

<output>
After completion, create `.planning/phases/15-mss-mapping-to-work-items/15-02-SUMMARY.md`:

# Phase 15 Plan 02: MSS UI Integration Summary

**[One-liner summarizing what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [Files with descriptions]

## Decisions Made
- [Key decisions]

## Issues Encountered
- [Problems and resolutions]

## Phase Complete

Phase 15 (MSS Mapping to Work Items) is now complete:
- **Plan 01**: Schema, server actions, AI integration
- **Plan 02**: MSS selector component, epic/story card UI

### Ready For
- **Phase 16**: MSS Dashboard & Reporting
</output>
