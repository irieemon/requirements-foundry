---
phase: 08-subtask-viewing
plan: 01
type: execute
---

<objective>
Add a dedicated subtasks section to the project detail page, following the established pattern used for stories (Phase 6).

Purpose: Provide visibility into generated subtasks with a KPI card and grouped display (subtasks grouped by story, stories grouped by epic).
Output: Working subtasks section accessible via `?section=subtasks` with accurate counts and clear hierarchy.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern reference (Phase 6 established the pattern):
@.planning/phases/06-stories-page/06-01-SUMMARY.md

# Key source files for the pattern:
@components/stories/stories-section.tsx
@components/stories/story-table.tsx
@components/ui/navigable-kpi-card.tsx
@server/actions/projects.ts
@app/projects/[id]/page.tsx

# Schema reference:
# Subtask: id, storyId, code, title, description, effort, runId, createdAt
# Story → Subtask[] (one-to-many)
# Display hierarchy: Epic → Story → Subtask

**Tech stack available:** Next.js 16, React, shadcn/ui, Prisma, Tailwind
**Established patterns:**
- StoriesSection: groups stories by epic, reuses StoryTable
- NavigableKpiCard: iconMap with whitelisted icons
- getProject: nested includes with _count for computed totals
- Section type union + activeSection pattern for tab navigation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend getProject to include subtasks in story data</name>
  <files>server/actions/projects.ts</files>
  <action>
Add subtasks to the stories select in getProject:
1. In the `stories` select block, add:
   - `subtasks` relation with `orderBy: { code: "asc" }` and select: `{ id, code, title, description, effort }`
   - `_count: { select: { subtasks: true } }` for subtask counts

This allows computing total subtask count client-side via `epics.reduce()` similar to how totalStories is computed.
  </action>
  <verify>TypeScript compiles, no errors in projects.ts</verify>
  <done>getProject returns nested subtasks within stories</done>
</task>

<task type="auto">
  <name>Task 2: Create SubtasksSection component and SubtaskTable</name>
  <files>components/subtasks/subtasks-section.tsx, components/subtasks/subtask-table.tsx</files>
  <action>
**Create components/subtasks/subtask-table.tsx:**
Simple table displaying subtasks with expandable rows (pattern from StoryTable but simpler):
- Columns: expand toggle, Code (badge), Title, Effort (badge)
- Expanded row shows full description
- Empty state with ListTodo icon

**Create components/subtasks/subtasks-section.tsx:**
Display subtasks grouped by story, stories grouped by epic (two-level grouping):
- Outer Card header: "Subtasks" with total count description
- For each epic with stories that have subtasks:
  - Card with epic code badge + title
  - For each story with subtasks in that epic:
    - Nested section with story code badge + title
    - SubtaskTable for that story's subtasks
- Empty state when no subtasks exist

Follow StoriesSection pattern but with an additional nesting level.
  </action>
  <verify>TypeScript compiles, both component files exist</verify>
  <done>SubtasksSection displays subtasks grouped by story within epic</done>
</task>

<task type="auto">
  <name>Task 3: Add Subtasks KPI card and section to project page</name>
  <files>app/projects/[id]/page.tsx, components/ui/navigable-kpi-card.tsx</files>
  <action>
**In navigable-kpi-card.tsx:**
1. Add ListTodo to the imports from lucide-react
2. Add "ListTodo" to the iconMap and iconName union type

**In app/projects/[id]/page.tsx:**
1. Import SubtasksSection from "@/components/subtasks/subtasks-section"
2. Import ListTodo from lucide-react (for empty state if needed elsewhere)
3. Add "subtasks" to the Section type union
4. Add "subtasks" to validSections array
5. Compute totalSubtasks:
   ```typescript
   const totalSubtasks = project.epics.reduce((sum, epic) =>
     sum + epic.stories.reduce((storySum, story) => storySum + (story._count?.subtasks || 0), 0), 0
   );
   ```
6. Add NavigableKpiCard for Subtasks after Stories card:
   ```tsx
   <NavigableKpiCard
     label="Subtasks"
     value={totalSubtasks}
     iconName="ListTodo"
     section="subtasks"
     projectId={project.id}
   />
   ```
7. Add section rendering after stories:
   ```tsx
   {activeSection === "subtasks" && (
     <SubtasksSection epics={project.epics} />
   )}
   ```
  </action>
  <verify>npm run build passes, no TypeScript errors</verify>
  <done>Subtasks KPI card visible, clicking navigates to subtasks section showing grouped subtasks</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Subtasks section with KPI card and hierarchical display (Epic → Story → Subtasks)</what-built>
  <how-to-verify>
**Test on production (Vercel):**

1. Navigate to a project that has generated subtasks
2. **Verify KPI card:**
   - Is there a Subtasks KPI card showing total count?
   - Does it appear in the navigation strip after Stories?
   - Does clicking it navigate to `?section=subtasks`?
3. **Verify subtasks display:**
   - Are subtasks grouped first by epic, then by story?
   - Does each epic show as a card with badge and title?
   - Does each story within show its subtasks in a table?
   - Can you expand subtask rows to see descriptions?
4. **Verify empty state:**
   - Navigate to a project without subtasks
   - Is there a clear empty state message?
5. **Verify counts:**
   - Does the KPI card count match the actual subtasks visible?
  </how-to-verify>
  <resume-signal>Type "pass" if working correctly, or describe specific issues observed</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Subtasks KPI card displays in navigation strip
- [ ] Clicking KPI card navigates to subtasks section
- [ ] Subtasks display in hierarchical grouping (Epic → Story → Subtask)
- [ ] Expandable rows show subtask descriptions
- [ ] Empty state displays when no subtasks exist
- [ ] Human verification passed on production
</verification>

<success_criteria>

- Subtasks section accessible via `?section=subtasks`
- KPI card shows accurate subtask count
- Subtasks displayed in hierarchical grouping (epic → story → subtask)
- Expandable rows reveal subtask details
- Follows established patterns from Phase 6 (stories page)
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/08-subtask-viewing/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Subtask Viewing Summary

**[One-liner: what shipped]**

## Performance

- **Duration:** X min
- **Tasks:** 4 (3 auto + 1 human verification)
- **Files modified:** 4

## Accomplishments

- Extended getProject to include nested subtasks
- Created SubtasksSection with two-level hierarchy display
- Added Subtasks KPI card to navigation strip
- Integrated subtasks section into project page

## Files Created/Modified

- `server/actions/projects.ts` - Added subtasks to stories include
- `components/subtasks/subtask-table.tsx` - New table component for subtask display
- `components/subtasks/subtasks-section.tsx` - New section with epic → story → subtask grouping
- `components/ui/navigable-kpi-card.tsx` - Added ListTodo icon
- `app/projects/[id]/page.tsx` - Added subtasks section, KPI card, computed totalSubtasks

## Decisions Made

[Key decisions and rationale, or "None"]

## Next Step

Phase 8 complete. Subtask viewing is now available on project detail page.
</output>
