---
phase: 13-mss-data-model
plan: 01
type: execute
---

<objective>
Create database schema for Master Service Schedule (MSS) L2/L3/L4 service hierarchy and CSV import functionality.

Purpose: Enable importing and storing MSS taxonomy data that will later be mapped to epics/stories for effort visibility by service line.
Output: Prisma models for MSS hierarchy, CSV import parser, server action for import.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./13-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase patterns
@prisma/schema.prisma
@lib/parsers/csv-parser.ts
@server/actions/uploads.ts

**Tech stack available:** Prisma 7.x, papaparse for CSV parsing, Next.js server actions
**Established patterns:**
- Hierarchical models with cascade delete (Epic → Story → Subtask)
- CSV parsing with papaparse and auto-column detection
- Server actions returning `{ success: boolean, error?: string, data?: T }`

**MSS Hierarchy:**
- L2 Service Line (top): e.g., "Infrastructure", "Application Development"
- L3 Service Area (mid): e.g., "Cloud Services", "Database Administration"
- L4 Activity (leaf): e.g., "AWS EC2 Management", "RDS Setup"

Each level has: code, name, description, optional parent relationship
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MSS models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add three new models at the end of schema.prisma (before closing):

1. **MssServiceLine** (L2 - top level):
   - id: String @id @default(cuid())
   - code: String @unique (e.g., "INF", "APP")
   - name: String (e.g., "Infrastructure")
   - description: String? @db.Text
   - createdAt: DateTime @default(now())
   - updatedAt: DateTime @updatedAt
   - Relation: serviceAreas MssServiceArea[]
   - Index on code

2. **MssServiceArea** (L3 - mid level):
   - id: String @id @default(cuid())
   - serviceLineId: String (FK to MssServiceLine)
   - serviceLine: MssServiceLine @relation
   - code: String (e.g., "CLD", "DBA") - unique within service line
   - name: String (e.g., "Cloud Services")
   - description: String? @db.Text
   - createdAt: DateTime @default(now())
   - updatedAt: DateTime @updatedAt
   - Relation: activities MssActivity[]
   - @@unique([serviceLineId, code])
   - Index on serviceLineId

3. **MssActivity** (L4 - leaf level):
   - id: String @id @default(cuid())
   - serviceAreaId: String (FK to MssServiceArea)
   - serviceArea: MssServiceArea @relation
   - code: String (e.g., "EC2", "RDS") - unique within service area
   - name: String (e.g., "AWS EC2 Management")
   - description: String? @db.Text
   - createdAt: DateTime @default(now())
   - updatedAt: DateTime @updatedAt
   - @@unique([serviceAreaId, code])
   - Index on serviceAreaId

Use onDelete: Cascade for all parent relations so deleting a service line removes all children.

Add a comment section header like existing models:
```
// ============================================
// Master Service Schedule (MSS) Taxonomy
// ============================================
```
  </action>
  <verify>npx prisma validate && npx prisma generate</verify>
  <done>Schema valid, Prisma client types generated, no errors</done>
</task>

<task type="auto">
  <name>Task 2: Create MSS CSV import functionality</name>
  <files>lib/mss/csv-import.ts, lib/mss/types.ts, server/actions/mss.ts</files>
  <action>
**lib/mss/types.ts** - Type definitions:
```typescript
export interface MssImportRow {
  l2Code: string;
  l2Name: string;
  l2Description?: string;
  l3Code: string;
  l3Name: string;
  l3Description?: string;
  l4Code: string;
  l4Name: string;
  l4Description?: string;
}

export interface MssColumnMapping {
  l2Code: string;
  l2Name: string;
  l2Description?: string;
  l3Code: string;
  l3Name: string;
  l3Description?: string;
  l4Code: string;
  l4Name: string;
  l4Description?: string;
}

export interface MssImportResult {
  serviceLines: number;
  serviceAreas: number;
  activities: number;
  errors: string[];
}
```

**lib/mss/csv-import.ts** - CSV parsing and import logic:
- Use papaparse to parse CSV (follow pattern from lib/parsers/csv-parser.ts)
- Implement `autoDetectMssColumns(headers: string[])` with flexible patterns:
  - L2 columns: /l2.*code/i, /service.*line.*code/i, /l2.*name/i, etc.
  - L3 columns: /l3.*code/i, /service.*area.*code/i, etc.
  - L4 columns: /l4.*code/i, /activity.*code/i, etc.
- Implement `parseMssCSV(csvContent: string, mapping?: MssColumnMapping)`:
  - Returns { rows: MssImportRow[], headers: string[], autoMapping: MssColumnMapping | null }
  - Skip rows with empty L2/L3/L4 codes
  - Trim all values
- Implement `importMssToDatabase(rows: MssImportRow[])`:
  - Use Prisma upsert pattern to handle duplicates gracefully
  - Process in order: L2 first, then L3, then L4
  - Use Map to track created IDs for parent lookups
  - Return MssImportResult with counts

**server/actions/mss.ts** - Server action:
```typescript
"use server"
import { parseMssCSV, importMssToDatabase } from "@/lib/mss/csv-import"

export async function importMssFromCSV(csvContent: string) {
  // Parse CSV
  // Validate mapping detected
  // Import to database
  // Return result or error
}

export async function getMssStats() {
  // Return counts of service lines, areas, activities
}
```

Follow existing server action patterns - return `{ success: true, data }` or `{ success: false, error }`.
  </action>
  <verify>
Create a small test CSV inline in the terminal and verify parsing works:
```bash
echo 'L2 Code,L2 Name,L3 Code,L3 Name,L4 Code,L4 Name
INF,Infrastructure,CLD,Cloud Services,EC2,AWS EC2 Management
INF,Infrastructure,CLD,Cloud Services,RDS,AWS RDS Setup
INF,Infrastructure,DBA,Database Admin,PG,PostgreSQL Management' > /tmp/test-mss.csv
```
Then test import via a simple script or inspect that types compile correctly.
  </verify>
  <done>
- lib/mss/types.ts exports type definitions
- lib/mss/csv-import.ts parses CSV and imports to DB
- server/actions/mss.ts exports importMssFromCSV and getMssStats
- Types compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Run migration and verify integration</name>
  <files>prisma/migrations/</files>
  <action>
1. Create and apply migration:
   ```bash
   npx prisma migrate dev --name add-mss-models
   ```

2. Verify the migration created the three tables with proper constraints

3. Quick integration test - create a simple test file or use prisma studio:
   - Create a service line
   - Create a service area under it
   - Create an activity under the area
   - Verify cascade delete works (delete service line removes children)

If using test file, add to lib/mss/__tests__/csv-import.test.ts following vitest patterns.
  </action>
  <verify>
- `npx prisma migrate status` shows no pending migrations
- `npx prisma db push --dry-run` shows no schema drift
- Tables exist in database with correct structure
  </verify>
  <done>
- Migration applied successfully
- MSS tables created (MssServiceLine, MssServiceArea, MssActivity)
- Foreign key constraints and indexes in place
- Basic CRUD operations work
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx prisma validate` passes
- [ ] `npx prisma migrate status` shows migrations applied
- [ ] `npm run build` succeeds without errors
- [ ] MSS types are exported and usable
- [ ] CSV import function parses test data correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- MSS hierarchy models exist in database
- CSV import ready for Phase 14 UI integration
</success_criteria>

<output>
After completion, create `.planning/phases/13-mss-data-model/13-01-SUMMARY.md`:

# Phase 13 Plan 01: MSS Data Model & Import Summary

**[One-liner describing what shipped]**

## Performance

- **Duration:** X min
- **Started:** YYYY-MM-DD
- **Completed:** YYYY-MM-DD

## Accomplishments

- [Key outcomes]

## Task Commits

1. **Task 1:** commit hash (type)
2. **Task 2:** commit hash (type)
3. **Task 3:** commit hash (type)

## Files Created/Modified

- `prisma/schema.prisma` - Added MSS models
- `lib/mss/types.ts` - MSS type definitions
- `lib/mss/csv-import.ts` - CSV parsing and import
- `server/actions/mss.ts` - Server actions

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 14: MSS Management UI
</output>
