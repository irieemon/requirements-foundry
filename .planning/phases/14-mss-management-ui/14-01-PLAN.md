---
phase: 14-mss-management-ui
plan: 01
type: execute
---

<objective>
Add CRUD server actions and create the MSS management page with hierarchy viewer.

Purpose: Establish the foundation for MSS taxonomy management - server-side operations and the main viewing interface.
Output: Working MSS page at `/mss` displaying the L2→L3→L4 hierarchy with expand/collapse.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 13 established MSS foundation:
@.planning/phases/13-mss-data-model/13-01-SUMMARY.md

# Existing MSS implementation:
@lib/mss/types.ts
@lib/mss/csv-import.ts
@server/actions/mss.ts
@prisma/schema.prisma

# UI patterns to follow:
@components/projects/create-project-dialog.tsx
@app/projects/page.tsx
@components/layout/page-header.tsx

**Tech stack available:** Next.js App Router, shadcn/ui, Prisma, Server Actions
**Established patterns:** Dialog components, PageHeader, collapsible sections
**Constraining decisions:**
- Phase 13: Upsert pattern for imports, cascade delete from L2
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CRUD server actions for L2/L3/L4</name>
  <files>server/actions/mss.ts, lib/mss/types.ts</files>
  <action>
Add server actions for individual CRUD operations on MSS entries:

**In lib/mss/types.ts, add input types:**
- MssServiceLineInput: { code: string; name: string; description?: string }
- MssServiceAreaInput: { serviceLineId: string; code: string; name: string; description?: string }
- MssActivityInput: { serviceAreaId: string; code: string; name: string; description?: string }

**In server/actions/mss.ts, add:**
1. createServiceLine(input: MssServiceLineInput) - Create L2 entry
2. updateServiceLine(id: string, input: Partial<MssServiceLineInput>) - Update L2
3. deleteServiceLine(id: string) - Delete L2 (cascades to L3/L4)
4. createServiceArea(input: MssServiceAreaInput) - Create L3 under L2
5. updateServiceArea(id: string, input: Partial<MssServiceAreaInput>) - Update L3
6. deleteServiceArea(id: string) - Delete L3 (cascades to L4)
7. createActivity(input: MssActivityInput) - Create L4 under L3
8. updateActivity(id: string, input: Partial<MssActivityInput>) - Update L4
9. deleteActivity(id: string) - Delete L4
10. getServiceLine(id: string) - Get single L2 with children
11. getServiceArea(id: string) - Get single L3 with children
12. getActivity(id: string) - Get single L4

Follow existing server action patterns:
- "use server" directive
- Return { success: true, data } or { success: false, error: string }
- Try/catch with console.error for failures
- Use db from @/lib/db

Code uniqueness constraint: L2 code is globally unique, L3 code is unique within L2, L4 code is unique within L3. Handle Prisma unique constraint errors gracefully with user-friendly messages.
  </action>
  <verify>npm run build passes with no TypeScript errors</verify>
  <done>All 12 server actions exist and type-check correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create MSS page with hierarchy viewer</name>
  <files>app/mss/page.tsx, components/mss/mss-hierarchy-viewer.tsx, components/mss/mss-service-line-item.tsx</files>
  <action>
**Create app/mss/page.tsx:**
- Server component that fetches hierarchy via getMssHierarchy()
- Uses PageHeader with title "Service Taxonomy" and description "Manage L2/L3/L4 service hierarchy"
- Actions slot: placeholder Button "Import CSV" (will be wired in Plan 02)
- Renders MssHierarchyViewer with the hierarchy data
- Shows empty state if no data: "No service taxonomy loaded. Import a CSV to get started."

**Create components/mss/mss-hierarchy-viewer.tsx:**
- Client component ("use client")
- Props: { serviceLines: MssServiceLine[] } where MssServiceLine includes nested serviceAreas/activities
- Renders list of MssServiceLineItem components
- Shows count summary at top: "X Service Lines, Y Service Areas, Z Activities"

**Create components/mss/mss-service-line-item.tsx:**
- Client component with expand/collapse state
- Uses Collapsible from shadcn/ui (or manual state with ChevronRight/ChevronDown icons)
- L2 row: code badge + name + expand toggle + action buttons (Edit, Delete - disabled for now)
- When expanded, shows L3 items indented
- L3 items similarly expandable to show L4 items
- Visual hierarchy: L2 bold, L3 medium, L4 normal weight
- Use consistent spacing/indentation (pl-4 for L3, pl-8 for L4)

**Styling:**
- Use Card component as container
- Hover states on rows for interactivity
- Muted text for descriptions (truncated with tooltip)
- Code badges: rounded bg-muted px-2 py-0.5 font-mono text-xs

**Icons:** ChevronRight, ChevronDown from lucide-react for expand/collapse
  </action>
  <verify>
1. npm run build passes
2. Navigate to http://localhost:3000/mss - page loads without errors
3. If MSS data exists, hierarchy displays with expand/collapse working
  </verify>
  <done>MSS page accessible at /mss, hierarchy viewer shows L2→L3→L4 with expand/collapse</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] All 12 server actions implemented and exported
- [ ] /mss page loads and displays hierarchy
- [ ] Expand/collapse works for all levels
- [ ] Empty state displays when no data
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- MSS page functional with hierarchy viewer
</success_criteria>

<output>
After completion, create `.planning/phases/14-mss-management-ui/14-01-SUMMARY.md`
</output>
