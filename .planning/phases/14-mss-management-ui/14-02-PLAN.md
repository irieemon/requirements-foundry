---
phase: 14-mss-management-ui
plan: 02
type: execute
---

<objective>
Add CSV import dialog and stats/clear functionality to the MSS management page.

Purpose: Enable users to import MSS taxonomy from CSV files and manage existing data.
Output: Working import dialog with file upload, stats display, and clear data functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/14-mss-management-ui/14-01-PLAN.md

# Existing MSS implementation:
@server/actions/mss.ts
@lib/mss/csv-import.ts
@lib/mss/types.ts

# UI patterns to follow:
@components/projects/create-project-dialog.tsx
@components/uploads/upload-dropzone.tsx

**Tech stack available:** Next.js App Router, shadcn/ui, Prisma, Server Actions
**Established patterns:** Dialog with form, file upload, toast notifications
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV import dialog</name>
  <files>components/mss/mss-import-dialog.tsx, app/mss/page.tsx</files>
  <action>
**Create components/mss/mss-import-dialog.tsx:**
- Client component with Dialog from shadcn/ui
- State: open, loading, csvContent, previewData, error
- Trigger: Button with Upload icon "Import CSV"

**Dialog content:**
1. File input area:
   - Accept .csv files only
   - On file select, read as text using FileReader
   - Store content in state

2. Preview section (after file loaded):
   - Parse first 5 rows to show preview table
   - Show detected column mapping (L2 Code, L2 Name, etc.)
   - Display row count: "X rows detected"

3. Import button:
   - Calls importMssFromCSV(csvContent) server action
   - Shows loading spinner during import
   - On success: toast.success with counts, close dialog, trigger page refresh
   - On error: display error message in dialog (don't close)

4. Cancel button to close dialog

**Wire into app/mss/page.tsx:**
- Replace placeholder Import button with MssImportDialog component
- Pass onSuccess callback to refresh data (use router.refresh())

**File reading pattern:**
```typescript
const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    setCsvContent(event.target?.result as string);
  };
  reader.readAsText(file);
};
```

**Preview parsing:** Split by newlines, take first 5, split by comma, display in simple table.
  </action>
  <verify>npm run build passes without errors</verify>
  <done>Import dialog component created and wired into MSS page</done>
</task>

<task type="auto">
  <name>Task 2: Add stats display and clear functionality</name>
  <files>components/mss/mss-stats-card.tsx, components/mss/mss-clear-dialog.tsx, app/mss/page.tsx</files>
  <action>
**Create components/mss/mss-stats-card.tsx:**
- Server component (or client with useEffect fetch)
- Displays: Service Lines count, Service Areas count, Activities count
- Uses KpiCard or simple Card with 3 stat items in a row
- Shows "No data" state when all counts are 0

**Create components/mss/mss-clear-dialog.tsx:**
- Confirmation dialog before clearing all MSS data
- AlertDialog from shadcn/ui for destructive action
- Title: "Clear Service Taxonomy"
- Description: "This will permanently delete all X service lines, Y service areas, and Z activities. This action cannot be undone."
- Cancel and "Clear All Data" (destructive variant) buttons
- Calls clearMssData() on confirm
- Toast on success/error
- Triggers page refresh on success

**Update app/mss/page.tsx:**
- Add MssStatsCard above hierarchy viewer
- Add MssClearDialog trigger button (Trash2 icon, ghost variant) in PageHeader actions alongside Import
- Pass stats data to clear dialog for the confirmation message

**Layout suggestion:**
```
[PageHeader: "Service Taxonomy" | [Import CSV] [Clear] ]
[Stats Card: 3 Service Lines | 12 Service Areas | 45 Activities]
[Hierarchy Viewer...]
```
  </action>
  <verify>npm run build passes without errors</verify>
  <done>Stats card and clear dialog implemented and integrated</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>MSS import, stats display, and clear functionality</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/mss
    3. Verify stats show current counts (or "No data" if empty)
    4. Click "Import CSV" button
    5. Select a test MSS CSV file (or create one with L2/L3/L4 columns)
    6. Verify preview shows first rows and detected columns
    7. Click Import - verify success toast and data appears
    8. Verify stats update with new counts
    9. Click Clear (trash icon) - verify confirmation dialog
    10. Cancel first, then clear - verify data removed and stats reset
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Import dialog accepts CSV and shows preview
- [ ] Import successfully loads data with toast feedback
- [ ] Stats card shows accurate counts
- [ ] Clear dialog confirms before deleting
- [ ] Clear successfully removes all data
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified import/clear flow works end-to-end
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-mss-management-ui/14-02-SUMMARY.md`
</output>
