---
phase: 02-card-analysis-progress
plan: 01
type: execute
---

<objective>
Fix the "frozen progress" perception during card analysis by enhancing visual feedback.

Purpose: The progress bar only updates when documents COMPLETE, but AI analysis per document takes 30-60+ seconds. Users see no movement during this time and perceive the UI as frozen. This plan adds intermediate feedback so users always know the system is working.

Output: Card analysis progress panel that provides continuous visual feedback during AI processing, eliminating the "frozen" perception.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-investigation-instrumentation/01-01-SUMMARY.md
@.planning/phases/01-investigation-instrumentation/01-02-SUMMARY.md
@.planning/phases/01-investigation-instrumentation/DISCOVERY.md

**Relevant source files:**
@components/analysis/run-progress-panel.tsx
@hooks/use-run-progress.ts
@server/actions/analysis.ts
@app/api/runs/[id]/route.ts

**Root cause from investigation:**
The progress bar calculation only counts COMPLETED items: `(completedUploads + failedUploads) / totalUploads`. During AI analysis (30-60+ seconds per document), the bar stays at 0% for the first document, then jumps to 20% when complete. This creates the "frozen" perception even though the system IS working and status IS updating to ANALYZING.

**What's already working:**
- Polling at 1s interval ✓
- Cache headers prevent stale data ✓
- Per-upload status transitions (PENDING → LOADING → ANALYZING → SAVING → COMPLETED) ✓
- phaseDetail updates with current document name ✓
- RunLogger integrated for structured logging ✓

**What's missing:**
- No visual feedback that analysis is actively happening (beyond status pill)
- No elapsed time shown during processing
- Progress bar doesn't reflect "in progress" items
- The current document being analyzed isn't prominently displayed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prominent current-document indicator and elapsed time</name>
  <files>components/analysis/run-progress-panel.tsx</files>
  <action>
Add a "Currently Processing" section above the document list when a run is active. This section should:

1. Show the current document name from `progress.phaseDetail` in a highlighted banner
2. Add an elapsed time counter that updates every second showing how long the current document has been processing
3. Add a pulsing animation or progress indicator to show the AI is actively working
4. When no document is actively being processed (all PENDING or all COMPLETED), hide this section

Implementation details:
- Add a `useEffect` with 1-second interval to update elapsed time display when run is active
- Parse `progress.phaseDetail` to extract document name (format: "Processing upload X of Y: filename")
- Use the `isActive` computed value to show/hide the section
- Style with primary color background to draw attention

Avoid: Adding new API calls or changing polling interval. This is purely frontend display enhancement using existing data.
  </action>
  <verify>
`npm run build` passes. The RunProgressPanel component renders a "Currently Processing" section when status is RUNNING with:
- Current document name visible
- Elapsed time counter that updates
- Visual pulsing/animation indicator
  </verify>
  <done>
- Build passes with no TypeScript errors
- Currently processing section appears during RUNNING status
- Elapsed time updates every second
- Section hidden when run completes
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance progress bar to show "in progress" state</name>
  <files>components/analysis/run-progress-panel.tsx</files>
  <action>
Modify the progress bar to provide visual feedback during active processing:

1. Add a secondary "in-progress" indicator within the progress bar:
   - Completed items show as solid fill (current behavior)
   - The currently processing item shows as a striped/animated section
   - This gives the appearance of progress even during long AI calls

2. Update the progress text to show three-part status:
   - Current: "1 of 5 documents processed (1 analyzing)"
   - Instead of: "1 of 5 documents processed"

3. Add a subtle shimmer/pulse animation to the progress bar when actively processing

Implementation:
- Detect if any upload has status LOADING, ANALYZING, or SAVING
- If so, add a striped/animated segment after the solid progress
- Use CSS animations (animate-pulse or custom shimmer) for the active section
- Update the text below progress bar to include "analyzing" count

Avoid: Changing the underlying progress calculation logic or API responses. This is purely visual enhancement.
  </action>
  <verify>
`npm run build` passes. Visual inspection confirms:
- Progress bar shows solid fill for completed items
- Progress bar shows animated/striped section for in-progress item
- Text shows "(X analyzing)" when items are being processed
  </verify>
  <done>
- Build passes with no TypeScript errors
- Progress bar has two visual states: completed (solid) and in-progress (animated)
- Progress text includes count of items being analyzed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced card analysis progress panel with continuous visual feedback</what-built>
  <how-to-verify>
    1. Deploy to Vercel production (user can only test there)
    2. Navigate to a project with uploaded documents
    3. Click "Analyze" to start card analysis
    4. Observe the progress panel:
       - [ ] "Currently Processing" banner appears showing document name
       - [ ] Elapsed time counter updates every second
       - [ ] Progress bar shows animated section for in-progress document
       - [ ] Progress text shows "(X analyzing)" during AI processing
    5. Wait for first document to complete:
       - [ ] Progress bar jumps to show completion
       - [ ] "Currently Processing" updates to next document
    6. Let run complete:
       - [ ] "Currently Processing" section disappears
       - [ ] Final state shows success
  </how-to-verify>
  <resume-signal>Type "approved" if progress panel no longer appears frozen, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors introduced
- [ ] Progress panel shows continuous visual feedback during AI analysis
- [ ] "Frozen" perception is eliminated - users can see the system is working
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Card analysis progress provides continuous visual feedback
- Users never see a "frozen" UI during analysis
</success_criteria>

<output>
After completion, create `.planning/phases/02-card-analysis-progress/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Card Analysis Progress Fix Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

[Ready for Phase 3 or describe what's next]
</output>
