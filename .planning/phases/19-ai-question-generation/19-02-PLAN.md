---
phase: 19-ai-question-generation
plan: 02
type: execute
---

<objective>
Create the UI components for displaying AI questions and collecting answers, and integrate the questions step into the upload flow.

Purpose: Enable users to see AI-generated clarifying questions after upload and provide answers before analysis starts.
Output: Question display component, modified upload/analysis flow with questions step.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-ai-question-generation/19-01-SUMMARY.md

**Codebase context:**
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md

**Upload flow (from Phase 18):**
@components/uploads/multi-file-upload.tsx
@components/uploads/upload-context-form.tsx
@components/analysis/analyze-panel.tsx

**Server actions (from 19-01):**
@server/actions/questions.ts

**Schemas (from 19-01):**
@lib/uploads/context-schema.ts

**Established patterns:**
- React-hook-form + Zod for form validation
- shadcn/ui components (Card, Button, Form, Textarea, Badge)
- Collapsible sections for optional content
- toast notifications via sonner
- Server actions called directly from client components
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI Questions display and answer component</name>
  <files>components/uploads/ai-questions-form.tsx</files>
  <action>
Create AIQuestionsForm component for displaying AI-generated questions and collecting user answers:

```typescript
"use client";

import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Loader2, Sparkles, MessageCircleQuestion, CheckCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { toast } from "sonner";
import type { AIQuestion, AIAnswersFormData } from "@/lib/uploads/context-schema";
import { aiAnswersFormSchema } from "@/lib/uploads/context-schema";
import { submitQuestionAnswers } from "@/server/actions/questions";

interface AIQuestionsFormProps {
  uploadId: string;
  questions: AIQuestion[];
  existingAnswers?: { questionId: string; answer: string }[];
  onSubmit: () => void;
  onSkip?: () => void;
}
```

Component features:
- Display each question in a card with:
  - Question text (prominent)
  - Category badge (scope, users, constraints, etc.)
  - Importance indicator (high/medium/low as colored dot or badge)
  - Context note (if provided) in muted text
  - Textarea for answer input
- Form validation ensures non-empty answers (or user explicitly skips)
- "Submit Answers" button calls submitQuestionAnswers server action
- Optional "Skip Questions" button (if onSkip provided)
- Loading state while submitting
- Success toast after submission
- If existingAnswers provided, pre-fill textareas (for editing)

Visual design:
- Use a numbered list or grid layout
- High importance questions should be visually distinct (border-primary or similar)
- Category badges use semantic colors (scope=blue, users=green, constraints=orange, etc.)
- Clean, focused UI - not overwhelming despite multiple questions
  </action>
  <verify>
TypeScript compiles without errors
Component renders in isolation (can test with mock questions)
Form validation works (submit with empty required fields shows errors)
  </verify>
  <done>
AIQuestionsForm component renders questions with answer textareas
Form submission calls server action and handles success/error
Existing answers can be pre-filled for editing
Visual hierarchy clear (importance, category visible)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create question generation trigger and status component</name>
  <files>components/uploads/questions-panel.tsx</files>
  <action>
Create QuestionsPanel component that orchestrates the questions flow for an upload:

```typescript
"use client";

import { useState, useEffect } from "react";
import { Loader2, Sparkles, MessageCircleQuestion, CheckCircle, AlertCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { toast } from "sonner";
import { AIQuestionsForm } from "./ai-questions-form";
import { generateQuestionsForUpload, getQuestionsForUpload } from "@/server/actions/questions";
import type { AIQuestion, AIAnswer } from "@/lib/uploads/context-schema";

interface QuestionsPanelProps {
  uploadId: string;
  uploadFilename: string;
  hasContext: boolean;
  onComplete: () => void;  // Called when questions answered or skipped
  onSkip: () => void;      // User skips the entire questions step
}
```

Component states:
1. **no-context**: User hasn't provided upload context - show message that context is needed first
2. **generate-prompt**: Context exists, no questions yet - show "Generate Questions" button
3. **generating**: AI is generating questions - show loading spinner
4. **pending-answers**: Questions generated, awaiting user answers - show AIQuestionsForm
5. **complete**: Answers submitted - show success summary

Flow:
- On mount, call getQuestionsForUpload to determine initial state
- "Generate Questions" button calls generateQuestionsForUpload
- Show AIQuestionsForm when questions exist and no answers yet
- After answers submitted, call onComplete callback
- "Skip" option available at generate-prompt and pending-answers states

Error handling:
- AI generation failure: Show error message with retry button
- Network errors: Toast notification
  </action>
  <verify>
TypeScript compiles without errors
Component handles all status transitions correctly
Loading states display appropriately
  </verify>
  <done>
QuestionsPanel component orchestrates full question flow
Status detection works (no-context, generate-prompt, generating, pending-answers, complete)
Generate button triggers AI and shows loading
AIQuestionsForm displayed when questions ready
Skip functionality available
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate questions into upload/analysis flow</name>
  <files>components/analysis/analyze-panel.tsx, app/projects/[id]/page.tsx</files>
  <action>
Modify AnalyzePanel to include the questions step before analysis:

1. Fetch question status for pending uploads
2. Add a pre-analysis step that shows QuestionsPanel for uploads with context but without answered questions
3. Analysis can only start when:
   - No uploads have pending questions (all answered or skipped), OR
   - User explicitly chooses to "Analyze without questions"

Update AnalyzePanel component:
```typescript
// Add state for tracking question status
const [uploadsWithPendingQuestions, setUploadsWithPendingQuestions] = useState<string[]>([]);

// Check question status on mount and when uploads change
useEffect(() => {
  async function checkQuestionStatus() {
    const pending = [];
    for (const upload of pendingUploads) {
      const status = await getQuestionsForUpload(upload.id);
      // Upload has context + questions but no answers = pending
      if (status.status === 'pending-answers') {
        pending.push(upload.id);
      }
    }
    setUploadsWithPendingQuestions(pending);
  }
  checkQuestionStatus();
}, [pendingUploads]);
```

Show questions section above analyze button when pending questions exist:
- Expandable card showing "X uploads have unanswered questions"
- Click to expand and see QuestionsPanel for each
- Can still analyze without answering (with confirmation)

The flow becomes:
1. Upload documents
2. Context form (optional)
3. **NEW: Questions appear for uploads WITH context**
4. Answer questions (optional but encouraged)
5. Analyze

Keep backward compatible:
- Uploads without context skip questions entirely
- User can skip questions and analyze directly
- Existing functionality unchanged for uploads without the new flow
  </action>
  <verify>
npm run build succeeds
Upload flow works end-to-end:
1. Upload file with context → questions generated
2. Answer questions → can analyze
3. Upload file without context → can analyze directly (no questions)
  </verify>
  <done>
AnalyzePanel shows pending questions before analysis
Questions flow integrated but optional
Analyze still works for uploads without context
Full flow: upload → context → questions → answers → analyze
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>AI Questions flow integrated into upload/analysis pipeline</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Navigate to a project
    3. Upload a document WITH context (fill in some context fields)
    4. After upload completes, look for "Generate Questions" option
    5. Click "Generate Questions" - should see AI-generated questions
    6. Answer at least one question and submit
    7. Verify the Analyze button works
    8. Test alternative flow: Upload WITHOUT context - should be able to analyze directly
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] AIQuestionsForm renders and submits correctly
- [ ] QuestionsPanel handles all status states
- [ ] AnalyzePanel integrates questions step
- [ ] Upload with context → questions flow works
- [ ] Upload without context → direct analysis works
- [ ] Human verification completed
</verification>

<success_criteria>
- AI questions display in clean, focused UI
- Users can answer questions before analysis
- Questions step is optional (can skip)
- Backward compatible with existing upload flow
- No regression in analysis functionality
- Phase 19 complete
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-question-generation/19-02-SUMMARY.md` using summary template.
</output>
