---
phase: 07-subtask-generation
plan: 01
type: execute
---

<objective>
Add Subtask and RunStory models to the database schema, enabling subtask generation tracking.

Purpose: Establish the data foundation for subtask generation, following the RunEpic junction pattern.
Output: Prisma schema with Subtask model and RunStory junction, database migrated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant source files:
@prisma/schema.prisma

# Established patterns (from story generation):
- RunEpic junction model tracks per-epic progress with status enum
- Story model has epicId foreign key, code (S1, S2), and generation metadata
- Run model has type field distinguishing GENERATE_STORIES vs GENERATE_EPICS
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Subtask model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add Subtask model following the Story pattern:

```prisma
model Subtask {
  id          String   @id @default(cuid())
  storyId     String
  story       Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  code        String   // ST1, ST2, etc. unique per story
  title       String
  description String?  @db.Text
  effort      String?  // XS, S, M, L, XL or hours
  runId       String?  // which generation run created this
  createdAt   DateTime @default(now())

  @@unique([storyId, code])
  @@index([storyId])
  @@index([runId])
}
```

Also add the relation to Story model:
```prisma
model Story {
  // existing fields...
  subtasks    Subtask[]
}
```
  </action>
  <verify>npx prisma validate passes</verify>
  <done>Subtask model defined with story relation and proper indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add RunStory junction model</name>
  <files>prisma/schema.prisma</files>
  <action>
Add RunStory junction model following RunEpic pattern:

```prisma
model RunStory {
  id              String         @id @default(cuid())
  runId           String
  run             Run            @relation(fields: [runId], references: [id], onDelete: Cascade)
  storyId         String
  story           Story          @relation(fields: [storyId], references: [id], onDelete: Cascade)
  status          RunStoryStatus @default(PENDING)
  subtasksCreated Int            @default(0)
  subtasksDeleted Int            @default(0)
  tokensUsed      Int?
  durationMs      Int?
  errorMsg        String?
  retryCount      Int            @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([runId, storyId])
  @@index([runId])
  @@index([storyId])
}

enum RunStoryStatus {
  PENDING
  GENERATING
  SAVING
  COMPLETED
  FAILED
  SKIPPED
}
```

Add relation to Run model:
```prisma
model Run {
  // existing fields...
  runStories  RunStory[]
}
```

Add relation to Story model:
```prisma
model Story {
  // existing fields...
  runStories  RunStory[]
}
```
  </action>
  <verify>npx prisma validate passes</verify>
  <done>RunStory junction model defined with run and story relations</done>
</task>

<task type="auto">
  <name>Task 3: Add GENERATE_SUBTASKS to RunType enum</name>
  <files>prisma/schema.prisma</files>
  <action>
Update RunType enum to include subtask generation:

```prisma
enum RunType {
  ANALYZE_CARDS
  GENERATE_EPICS
  GENERATE_STORIES
  GENERATE_SUBTASKS  // Add this
}
```

This allows the Run model to distinguish subtask generation runs from other types.
  </action>
  <verify>npx prisma validate passes</verify>
  <done>RunType enum includes GENERATE_SUBTASKS</done>
</task>

<task type="auto">
  <name>Task 4: Push schema changes to database</name>
  <files>prisma/schema.prisma</files>
  <action>
Run prisma db push to apply schema changes:

```bash
npx prisma db push
```

Then generate updated Prisma client:

```bash
npx prisma generate
```

Verify the types are available in the codebase.
  </action>
  <verify>npx prisma db push succeeds, npx tsc --noEmit passes</verify>
  <done>Database updated with new models, TypeScript types generated</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx prisma validate` passes
- [ ] `npx prisma db push` succeeds
- [ ] `npx tsc --noEmit` passes (types available)
- [ ] Subtask model has story relation
- [ ] RunStory model has run and story relations
- [ ] RunType enum includes GENERATE_SUBTASKS
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Database schema ready for subtask generation
- Prisma client types generated
</success_criteria>

<output>
After completion, create `.planning/phases/07-subtask-generation/07-01-SUMMARY.md`
</output>
