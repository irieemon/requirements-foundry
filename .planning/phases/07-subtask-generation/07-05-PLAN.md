---
phase: 07-subtask-generation
plan: 05
type: execute
---

<objective>
Integrate subtask generation UI into the epic detail page.

Purpose: Wire up the SubtaskConfigDialog and SubtaskRunProgress components so users can trigger and monitor subtask generation.
Output: Working "Generate Subtasks" button on epic page with progress display.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-subtask-generation/07-04-SUMMARY.md

# Components to integrate:
@components/subtasks/subtask-config-dialog.tsx
@components/subtasks/subtask-run-progress.tsx
@hooks/use-subtask-progress.ts

# Target page:
@app/projects/[id]/epics/[epicId]/page.tsx

# Pattern to follow (story generation integration):
@components/stories/generate-stories-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SubtaskConfigDialog to epic detail page</name>
  <files>app/projects/[id]/epics/[epicId]/page.tsx</files>
  <action>
Import and render SubtaskConfigDialog on the epic detail page:

1. Add imports:
```typescript
import { SubtaskConfigDialog } from "@/components/subtasks/subtask-config-dialog";
```

2. Add dialog after the StoryTable Card (around line 174):
```typescript
{/* Subtask Generation */}
{epic.stories.length > 0 && (
  <Card className="border-border/50">
    <CardHeader>
      <CardTitle>Subtasks</CardTitle>
      <CardDescription>
        Break down user stories into implementable subtasks.
      </CardDescription>
    </CardHeader>
    <CardContent>
      <SubtaskConfigDialog
        epicId={epic.id}
        stories={epic.stories.map(s => ({
          id: s.id,
          code: s.code,
          title: s.title,
          _count: { subtasks: s.subtasks?.length || 0 }
        }))}
      />
    </CardContent>
  </Card>
)}
```
  </action>
  <validation>TypeScript compiles without errors</validation>
</task>

<task type="auto">
  <name>Task 2: Create SubtaskGenerationSection wrapper component</name>
  <files>components/subtasks/subtask-generation-section.tsx</files>
  <action>
Create a client component that wraps the dialog and progress display:

```typescript
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { SubtaskConfigDialog } from "./subtask-config-dialog";
import { SubtaskRunProgress } from "./subtask-run-progress";
import { useActiveSubtaskRun } from "@/hooks/use-subtask-progress";

interface Story {
  id: string;
  code: string;
  title: string;
  _count?: { subtasks: number };
}

interface SubtaskGenerationSectionProps {
  epicId: string;
  projectId: string;
  stories: Story[];
}

export function SubtaskGenerationSection({
  epicId,
  projectId,
  stories,
}: SubtaskGenerationSectionProps) {
  const router = useRouter();
  const [activeRunId, setActiveRunId] = useState<string | null>(null);
  const { activeRunId: existingRunId, isChecking } = useActiveSubtaskRun(projectId);

  // Use existing run if found, or new run if started
  const runId = activeRunId || existingRunId;

  const handleStarted = (newRunId: string) => {
    setActiveRunId(newRunId);
  };

  const handleComplete = () => {
    setActiveRunId(null);
    router.refresh();
  };

  if (isChecking) {
    return null; // Or skeleton
  }

  return (
    <Card className="border-border/50">
      <CardHeader>
        <CardTitle>Subtask Generation</CardTitle>
        <CardDescription>
          Break down user stories into implementable subtasks.
        </CardDescription>
      </CardHeader>
      <CardContent>
        {runId ? (
          <SubtaskRunProgress
            runId={runId}
            onComplete={handleComplete}
            onCancel={handleComplete}
          />
        ) : (
          <SubtaskConfigDialog
            epicId={epicId}
            stories={stories}
            onStarted={handleStarted}
          />
        )}
      </CardContent>
    </Card>
  );
}
```
  </action>
  <validation>TypeScript compiles without errors</validation>
</task>

<task type="auto">
  <name>Task 3: Update epic page to use SubtaskGenerationSection</name>
  <files>app/projects/[id]/epics/[epicId]/page.tsx</files>
  <action>
Replace the simple dialog integration with the wrapper component:

1. Update import:
```typescript
import { SubtaskGenerationSection } from "@/components/subtasks/subtask-generation-section";
```

2. Replace the Card with:
```typescript
{/* Subtask Generation */}
{epic.stories.length > 0 && (
  <SubtaskGenerationSection
    epicId={epic.id}
    projectId={id}
    stories={epic.stories.map(s => ({
      id: s.id,
      code: s.code,
      title: s.title,
      _count: { subtasks: s.subtasks?.length || 0 }
    }))}
  />
)}
```
  </action>
  <validation>TypeScript compiles without errors</validation>
</task>

<task type="auto">
  <name>Task 4: Update getEpic to include subtask counts</name>
  <files>server/actions/epics.ts</files>
  <action>
Ensure getEpic includes subtask counts for each story:

In the Prisma query, add _count to the stories include:
```typescript
stories: {
  include: {
    _count: {
      select: { subtasks: true }
    }
  },
  orderBy: { sortOrder: "asc" }
}
```
  </action>
  <validation>TypeScript compiles, subtask counts appear in UI</validation>
</task>

<task type="checkpoint:human-verify">
  <name>Task 5: Verify subtask generation works end-to-end</name>
  <action>
Human verification steps:
1. Run: npm run dev
2. Navigate to a project with epics that have stories
3. Click on an epic to view its stories
4. Look for "Subtask Generation" card below the stories table
5. Click "Generate Subtasks" button
6. Configure: select stories, choose mode, set behavior for existing
7. Click "Start Generation"
8. Observe progress display with timeline and story queue
9. Wait for completion
10. Verify subtasks appear (may need to add subtask display in future plan)
  </action>
</task>

</tasks>
