---
phase: 07-subtask-generation
plan: 03
type: execute
---

<objective>
Add AI prompt and provider method for subtask generation.

Purpose: Enable the AI to break down user stories into actionable subtasks.
Output: Working generateSubtasks method in AnthropicProvider.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-subtask-generation/07-01-SUMMARY.md
@.planning/phases/07-subtask-generation/07-02-SUMMARY.md

# Relevant source files (patterns to follow):
@lib/ai/anthropic-provider.ts
@lib/ai/prompts/story-prompt.ts

# Key patterns:
- generateStories takes epic data and mode, returns StoryData[]
- Prompts use structured JSON output format
- Mode controls story count (compact: 5-8, standard: 8-12, detailed: 12-15)
- Response is parsed and validated before returning
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subtask generation prompt</name>
  <files>lib/ai/prompts/subtask-prompt.ts</files>
  <action>
Create prompt file following story-prompt.ts pattern:

```typescript
import type { Story } from "@prisma/client";

export type SubtaskMode = "compact" | "standard" | "detailed";

interface SubtaskModeConfig {
  min: number;
  max: number;
  focus: string;
  includeAcceptanceCriteriaBreakdown: boolean;
  includeTechnicalTasks: boolean;
}

const MODE_CONFIGS: Record<SubtaskMode, SubtaskModeConfig> = {
  compact: {
    min: 3,
    max: 5,
    focus: "Core implementation tasks only",
    includeAcceptanceCriteriaBreakdown: false,
    includeTechnicalTasks: false,
  },
  standard: {
    min: 5,
    max: 8,
    focus: "Implementation tasks with testing",
    includeAcceptanceCriteriaBreakdown: true,
    includeTechnicalTasks: false,
  },
  detailed: {
    min: 8,
    max: 12,
    focus: "Comprehensive breakdown including technical setup",
    includeAcceptanceCriteriaBreakdown: true,
    includeTechnicalTasks: true,
  },
};

export interface SubtaskData {
  title: string;
  description: string | null;
  effort: string;
}

interface StoryWithEpic extends Story {
  epic?: { code: string; title: string } | null;
}

export function buildSubtaskPrompt(story: StoryWithEpic, mode: SubtaskMode): string {
  const config = MODE_CONFIGS[mode];

  // Parse acceptance criteria if stored as JSON
  let acceptanceCriteria: string[] = [];
  if (story.acceptanceCriteria) {
    try {
      acceptanceCriteria = JSON.parse(story.acceptanceCriteria);
    } catch {
      acceptanceCriteria = [story.acceptanceCriteria];
    }
  }

  return `You are a technical lead breaking down user stories into implementable subtasks.

STORY:
Code: ${story.code}
Title: ${story.title}
User Story: ${story.userStory}
${story.persona ? `Persona: ${story.persona}` : ""}
${story.epic ? `Epic: ${story.epic.code} - ${story.epic.title}` : ""}

ACCEPTANCE CRITERIA:
${acceptanceCriteria.length > 0 ? acceptanceCriteria.map((ac, i) => `${i + 1}. ${ac}`).join("\n") : "None specified"}

${story.technicalNotes ? `TECHNICAL NOTES:\n${story.technicalNotes}` : ""}

GENERATION MODE: ${mode}
- Generate ${config.min}-${config.max} subtasks
- Focus: ${config.focus}
- Break down acceptance criteria: ${config.includeAcceptanceCriteriaBreakdown ? "Yes" : "No"}
- Include technical setup tasks: ${config.includeTechnicalTasks ? "Yes" : "No"}

SUBTASK GUIDELINES:
- Each subtask should be completable in 1-4 hours
- Use action verbs: "Create", "Implement", "Add", "Configure", "Write"
- Be specific about what needs to be done
- Effort estimates: XS (< 1hr), S (1-2hr), M (2-4hr), L (4-8hr)

OUTPUT FORMAT:
Return a JSON array of subtasks. Each subtask must have:
- title: Action-oriented task title (string)
- description: Brief description of what to do (string or null)
- effort: Size estimate (string: "XS", "S", "M", or "L")

Return ONLY valid JSON array, no other text:
[
  { "title": "Create user input form component", "description": "Build React form with validation for email and password fields", "effort": "M" },
  ...
]`;
}

export function parseSubtaskResponse(content: string): SubtaskData[] {
  // Extract JSON from response (handle markdown code blocks)
  let jsonStr = content.trim();

  // Remove markdown code blocks if present
  if (jsonStr.startsWith("```json")) {
    jsonStr = jsonStr.slice(7);
  } else if (jsonStr.startsWith("```")) {
    jsonStr = jsonStr.slice(3);
  }
  if (jsonStr.endsWith("```")) {
    jsonStr = jsonStr.slice(0, -3);
  }
  jsonStr = jsonStr.trim();

  const parsed = JSON.parse(jsonStr);

  if (!Array.isArray(parsed)) {
    throw new Error("Response is not an array");
  }

  return parsed.map((item, index) => ({
    title: String(item.title || `Subtask ${index + 1}`),
    description: item.description ? String(item.description) : null,
    effort: String(item.effort || "M"),
  }));
}
```
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>Subtask prompt template created with mode configurations</done>
</task>

<task type="auto">
  <name>Task 2: Add generateSubtasks method to AnthropicProvider</name>
  <files>lib/ai/anthropic-provider.ts</files>
  <action>
Add generateSubtasks method to the AnthropicProvider class:

1. Import the prompt utilities at the top:
```typescript
import { buildSubtaskPrompt, parseSubtaskResponse, type SubtaskData, type SubtaskMode } from "./prompts/subtask-prompt";
```

2. Add the method to the class (follow generateStories pattern):
```typescript
async generateSubtasks(
  story: Story & { epic?: { code: string; title: string } | null },
  mode: SubtaskMode = "standard"
): Promise<SubtaskData[]> {
  const prompt = buildSubtaskPrompt(story, mode);

  const response = await this.client.messages.create({
    model: this.model,
    max_tokens: 2000,
    messages: [{ role: "user", content: prompt }],
  });

  const content = response.content[0];
  if (content.type !== "text") {
    throw new Error("Unexpected response type");
  }

  return parseSubtaskResponse(content.text);
}
```

Note: The Story type needs to be imported from Prisma if not already.
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>AnthropicProvider can generate subtasks from stories</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] Prompt follows established pattern
- [ ] Response parsing handles edge cases
- [ ] Mode configurations are sensible
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- generateSubtasks method ready for executor
- Prompt produces well-structured subtasks
</success_criteria>

<output>
After completion, create `.planning/phases/07-subtask-generation/07-03-SUMMARY.md`
</output>
