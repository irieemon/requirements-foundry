// Requirements Foundry - Prisma Schema
// PostgreSQL for production (Vercel), SQLite-compatible for local dev via env

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Core Entities
// ============================================

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String?  // Nullable for MVP; add auth later

  uploads Upload[]
  cards   Card[]
  epics   Epic[]
  runs    Run[]

  @@index([userId])
  @@index([createdAt])
}

model Upload {
  id               String   @id @default(cuid())
  projectId        String
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  filename         String?  // null if pasted text
  fileType         String   // MIME type: "text/plain", "application/pdf", etc.
  rawContent       String   // extracted text content (use @db.Text for large content)
  filePath         String?  // path to original file on disk (local mode only)

  // Vercel Blob storage fields (used when UPLOAD_STORAGE=blob)
  blobUrl          String?  // Public URL from Vercel Blob
  blobPathname     String?  // Pathname/key in Blob storage

  // Extraction and analysis status
  extractionStatus String   @default("PENDING") // PENDING, EXTRACTING, EXTRACTED, FAILED
  analysisStatus   String   @default("PENDING") // PENDING, QUEUED, ANALYZING, COMPLETED, FAILED, SKIPPED

  errorMsg         String?
  errorPhase       String?  // "extraction" | "analysis"
  createdAt        DateTime @default(now())

  // Extended fields for document processing
  fileSize         Int?     // file size in bytes
  processingMethod String?  // extractor used: "pdf-parse", "mammoth", etc.
  pageCount        Int?     // for PDFs
  slideCount       Int?     // for PPTX
  sheetCount       Int?     // for XLSX
  wordCount        Int?     // extracted word count
  hasImages        Boolean  @default(false)
  processingTimeMs Int?     // time to process

  // Track which run last analyzed this upload
  lastAnalyzedRunId String?
  lastAnalyzedAt    DateTime?

  cards      Card[]
  images     DocumentImage[]
  runUploads RunUpload[]

  @@index([projectId])
  @@index([extractionStatus])
  @@index([analysisStatus])
  @@index([projectId, analysisStatus])
}

model DocumentImage {
  id          String   @id @default(cuid())
  uploadId    String
  upload      Upload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  base64      String   // base64-encoded image data (consider size limits)
  mimeType    String   // image/png, image/jpeg, etc.
  index       Int      // order within document
  pageNumber  Int?     // for PDFs
  slideNumber Int?     // for PPTX
  width       Int?
  height      Int?
  description String?  // optional alt text or caption
  createdAt   DateTime @default(now())

  @@index([uploadId])
}

model Card {
  id              String   @id @default(cuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadId        String?
  upload          Upload?  @relation(fields: [uploadId], references: [id], onDelete: SetNull)

  // Track which run created this card
  runId           String?

  title           String
  problem         String?  // problem / opportunity
  targetUsers     String?  // target users/stakeholders
  currentState    String?
  desiredOutcomes String?  // KPIs
  constraints     String?
  systems         String?  // systems involved
  priority        String?  // high/medium/low or custom
  impact          String?
  rawText         String?  // original chunk if needed
  createdAt       DateTime @default(now())

  // Many-to-many with Epic stored as JSON references in Epic
  @@index([projectId])
  @@index([uploadId])
  @@index([runId])
}

model Epic {
  id                 String   @id @default(cuid())
  projectId          String
  project            Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  code               String   // E1, E2, etc.
  title              String
  theme              String?
  description        String?
  businessValue      String?
  acceptanceCriteria String?  // JSON array stored as string
  dependencies       String?  // JSON array of epic codes
  effort             String?  // S/M/L or story points
  impact             String?  // high/medium/low
  priority           Int?     // numeric for sorting
  cardIds            String?  // JSON array of card IDs that informed this epic
  runId              String?  // which run generated this
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  stories  Story[]
  runEpics RunEpic[]

  @@unique([projectId, code])
  @@index([projectId])
  @@index([runId])
}

model Story {
  id                 String    @id @default(cuid())
  epicId             String
  epic               Epic      @relation(fields: [epicId], references: [id], onDelete: Cascade)
  code               String    // S1, S2, etc. (within epic)
  title              String
  userStory          String    // "As a [persona], I want..."
  persona            String?
  acceptanceCriteria String?   // JSON array
  technicalNotes     String?
  priority           String?   // MoSCoW or numeric
  effort             String?   // story points or T-shirt
  runId              String?   // which run generated this
  createdAt          DateTime  @default(now())

  subtasks   Subtask[]
  runStories RunStory[]

  @@unique([epicId, code])
  @@index([epicId])
  @@index([runId])
}

model Subtask {
  id          String   @id @default(cuid())
  storyId     String
  story       Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  code        String   // ST1, ST2, etc. unique per story
  title       String
  description String?  @db.Text
  effort      String?  // XS, S, M, L, XL or hours
  runId       String?  // which generation run created this
  createdAt   DateTime @default(now())

  @@unique([storyId, code])
  @@index([storyId])
  @@index([runId])
}

// ============================================
// Run Tracking (AI Generation Jobs)
// ============================================

model Run {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  type        String    // ANALYZE_CARDS, GENERATE_EPICS, GENERATE_STORIES, GENERATE_ALL_STORIES, GENERATE_SUBTASKS, EXPORT
  status      String    @default("QUEUED") // QUEUED, RUNNING, SUCCEEDED, PARTIAL, FAILED, CANCELLED

  // Granular phase tracking
  phase       String    @default("INITIALIZING") // INITIALIZING, LOADING_CONTENT, ANALYZING, QUEUEING_EPICS, GENERATING_STORIES, SAVING_RESULTS, FINALIZING, COMPLETED, FAILED
  phaseDetail String?   // Optional detail: "Processing document 3 of 7"

  // Configuration
  inputConfig String?   // JSON: e.g., {"uploadIds": ["..."], "replaceExisting": false}

  // Progress counters
  totalItems      Int   @default(0)  // Total uploads/epics to process
  completedItems  Int   @default(0)  // Items completed
  failedItems     Int   @default(0)  // Items failed
  skippedItems    Int   @default(0)  // Items skipped (batch stories: epic had stories + skip mode)
  totalCards      Int   @default(0)  // Cards/stories created so far

  // Current processing pointer (for batch operations)
  currentItemId    String?  // Currently processing item ID (epicId or uploadId)
  currentItemIndex Int?     // 1-based index for display

  // Results
  outputData  String?   // JSON result
  errorMsg    String?
  logs        String?   // newline-separated log entries
  tokensUsed  Int?
  durationMs  Int?

  // Timestamps
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  // Heartbeat for stale run detection (Vercel serverless recovery)
  heartbeatAt DateTime?  // Last worker check-in time

  // Relations
  runUploads  RunUpload[]
  runEpics    RunEpic[]
  runStories  RunStory[]

  @@index([projectId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([projectId, status])
  @@index([projectId, type, status])
}

// ============================================
// Run-Upload Junction
// Tracks per-upload progress within a run
// ============================================

model RunUpload {
  id        String   @id @default(cuid())
  runId     String
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  uploadId  String
  upload    Upload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  // Per-upload status within this run
  status    String   @default("PENDING") // PENDING, LOADING, ANALYZING, SAVING, COMPLETED, FAILED, SKIPPED

  // Processing metrics
  startedAt    DateTime?
  completedAt  DateTime?
  durationMs   Int?
  tokensUsed   Int?

  // Results
  cardsCreated Int      @default(0)
  errorMsg     String?

  // Ordering
  order        Int      @default(0)  // Processing order

  createdAt    DateTime @default(now())

  @@unique([runId, uploadId])
  @@index([runId])
  @@index([uploadId])
  @@index([runId, status])
}

// ============================================
// Run-Epic Junction
// Tracks per-epic progress within a batch story generation run
// ============================================

model RunEpic {
  id        String   @id @default(cuid())
  runId     String
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  epicId    String
  epic      Epic     @relation(fields: [epicId], references: [id], onDelete: Cascade)

  // Status tracking
  status    String   @default("PENDING") // PENDING, GENERATING, SAVING, COMPLETED, FAILED, SKIPPED

  // Ordering for sequential processing
  order     Int      @default(0)

  // Timing
  startedAt    DateTime?
  completedAt  DateTime?
  durationMs   Int?

  // Token tracking (for cost estimation)
  tokensUsed   Int?

  // Results
  storiesCreated   Int      @default(0)
  storiesDeleted   Int      @default(0)  // When mode=replace
  errorMsg         String?
  retryCount       Int      @default(0)

  // Configuration snapshot (for audit/retry)
  mode             String?  // compact/standard/detailed
  personaSet       String?  // lightweight/core/full

  createdAt        DateTime @default(now())

  @@unique([runId, epicId])
  @@index([runId])
  @@index([epicId])
  @@index([runId, status])
}

// ============================================
// Run-Story Junction
// Tracks per-story progress within a batch subtask generation run
// ============================================

enum RunStoryStatus {
  PENDING
  GENERATING
  SAVING
  COMPLETED
  FAILED
  SKIPPED
}

model RunStory {
  id              String         @id @default(cuid())
  runId           String
  run             Run            @relation(fields: [runId], references: [id], onDelete: Cascade)
  storyId         String
  story           Story          @relation(fields: [storyId], references: [id], onDelete: Cascade)
  status          RunStoryStatus @default(PENDING)
  subtasksCreated Int            @default(0)
  subtasksDeleted Int            @default(0)
  tokensUsed      Int?
  durationMs      Int?
  errorMsg        String?
  retryCount      Int            @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([runId, storyId])
  @@index([runId])
  @@index([storyId])
  @@index([runId, status])
}

// ============================================
// Prompt Templates (Versioned)
// ============================================

model PromptTemplate {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "extract_cards", "generate_epics", "generate_stories"
  version     Int      @default(1)
  content     String   // the actual prompt template with {{placeholders}}
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name, isActive])
}
